<!DOCTYPE html> 
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Sign In | The Employee Playbook</title>

  <!-- Favicon (match your site structure) -->
  <link rel="icon" type="image/x-icon" href="assets/img/favicon.png">
  <link rel="icon" type="image/png" href="assets/img/favicon.png">

  <!-- Fonts / Icons -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --white: #fff;
      --light-gray: #f7f7f7;
      --gray: #e0e0e0;
      --dark-gray: #6b6b6b;
      --text: #37352f;
      --accent: #7B5FC4;
      --accent-dark: #5A4496;
      --shadow: 0 2px 10px rgba(0,0,0,0.08);
      --shadow-hover: 0 4px 15px rgba(0,0,0,0.12);
      --danger: #c0392b;
      --success: #1f7a4f;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }

    body {
      background: linear-gradient(135deg, #f0f2ff 0%, var(--white) 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .login-container {
      width: 100%;
      max-width: 380px;
      padding: 30px 25px;
      background: var(--white);
      border-radius: 12px;
      box-shadow: var(--shadow);
      border: 1px solid var(--gray);
      position: relative;
      overflow: hidden;
      animation: fadeIn 0.4s ease-out;
    }

    .login-container::before {
      content: '';
      position: absolute;
      top: 0; left: 0;
      width: 100%; height: 4px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
    }

    .login-header { text-align: center; margin-bottom: 18px; }

    .logo-container { display: flex; justify-content: center; margin-bottom: 18px; }

    .logo { height: 70px; width: auto; }

    .logo-fallback {
      font-size: 22px;
      font-weight: 700;
      color: var(--accent);
      display: none;
    }

    .login-title { font-size: 24px; font-weight: 700; margin-bottom: 8px; color: var(--text); }
    .login-subtitle { font-size: 14px; color: var(--dark-gray); line-height: 1.4; }

    .login-form { display: flex; flex-direction: column; gap: 16px; }

    .form-group { display: flex; flex-direction: column; gap: 6px; }

    .form-label { font-size: 13px; font-weight: 500; color: var(--text); }

    .form-input {
      padding: 12px 14px;
      border: 1px solid var(--gray);
      border-radius: 6px;
      font-size: 14px;
      transition: all 0.3s;
      width: 100%;
      background: var(--white);
      color: var(--text);
    }

    .form-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(123, 95, 196, 0.1);
    }

    .password-input-container { position: relative; width: 100%; }
    .password-input { padding-right: 40px; }

    .password-toggle {
      position: absolute;
      right: 12px;
      top: 50%;
      transform: translateY(-50%);
      background: none;
      border: none;
      color: var(--dark-gray);
      cursor: pointer;
      font-size: 13px;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.3s;
      border-radius: 4px;
    }
    .password-toggle:hover { color: var(--accent); }

    .form-options {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 5px;
    }

    .remember-me { display: flex; align-items: center; gap: 6px; }
    .remember-checkbox { width: 14px; height: 14px; accent-color: var(--accent); }
    .remember-label { font-size: 13px; color: var(--dark-gray); cursor: pointer; }

    .forgot-password {
      font-size: 13px;
      color: var(--accent);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s;
    }
    .forgot-password:hover { color: var(--accent-dark); }

    .login-button {
      background: var(--accent);
      color: white;
      border: none;
      padding: 12px 16px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s;
      margin-top: 5px;
      width: 100%;
      box-shadow: 0 3px 8px rgba(123, 95, 196, 0.2);
      display: inline-flex;
      justify-content: center;
      align-items: center;
      gap: 10px;
    }

    .login-button:hover {
      background: var(--accent-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(123, 95, 196, 0.3);
    }

    .login-button:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
    }

    .signup-link {
      text-align: center;
      margin-top: 18px;
      font-size: 13px;
      color: var(--dark-gray);
    }

    .signup-link a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
      transition: color 0.3s;
    }
    .signup-link a:hover { color: var(--accent-dark); }

    .status {
      display: none;
      margin: 10px 0 0;
      padding: 10px 12px;
      border-radius: 8px;
      font-size: 13px;
      line-height: 1.35;
      border: 1px solid var(--gray);
      background: var(--light-gray);
      color: var(--text);
    }
    .status.error {
      display: block;
      border-color: rgba(192, 57, 43, 0.25);
      background: rgba(192, 57, 43, 0.08);
      color: var(--danger);
    }
    .status.success {
      display: block;
      border-color: rgba(31, 122, 79, 0.25);
      background: rgba(31, 122, 79, 0.08);
      color: var(--success);
    }

    @media (max-width: 480px) {
      body { padding: 15px; }
      .login-container { padding: 25px 20px; max-width: 100%; }
      .logo { height: 60px; }
      .login-title { font-size: 22px; }
      .login-subtitle { font-size: 13px; }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>

<body>
  <div class="login-container">
    <div class="login-header">
      <div class="logo-container">
        <img
          src="assets/img/logo.png"
          alt="The Employee Playbook"
          class="logo"
          id="logo"
          onerror="this.style.display='none'; document.getElementById('logo-fallback').style.display='block';"
        >
        <div class="logo-fallback" id="logo-fallback">THE EMPLOYEE PLAYBOOK</div>
      </div>

      <h1 class="login-title">Sign In</h1>
      <p class="login-subtitle">Access your Employee Playbook account</p>
    </div>

    <form class="login-form" id="loginForm">
      <div class="form-group">
        <label for="email" class="form-label">Email Address</label>
        <input type="email" id="email" class="form-input" placeholder="you@example.com" required autocomplete="email">
      </div>

      <div class="form-group">
        <label for="password" class="form-label">Password</label>
        <div class="password-input-container">
          <input type="password" id="password" class="form-input password-input" placeholder="Enter your password" required autocomplete="current-password">
          <button type="button" class="password-toggle" id="passwordToggle" aria-label="Show/hide password">
            <i class="fas fa-eye"></i>
          </button>
        </div>
      </div>

      <div class="form-options">
        <div class="remember-me">
          <input type="checkbox" id="remember" class="remember-checkbox" checked>
          <label for="remember" class="remember-label">Remember me</label>
        </div>
        <a href="forgot-password.html" class="forgot-password">Forgot password?</a>
      </div>

      <button type="submit" class="login-button" id="loginBtn">
        <span>Sign In</span>
        <i class="fas fa-arrow-right"></i>
      </button>

      <div id="statusBox" class="status" role="status" aria-live="polite"></div>

      <div class="signup-link">Don't have an account? <a href="create-account.html">Sign up here</a></div>
    </form>
  </div>

  <!-- Load Supabase ONCE + your client ONCE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="assets/supabaseClient.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Password toggle
      const toggleBtn = document.getElementById('passwordToggle');
      const passwordInput = document.getElementById('password');

      toggleBtn.addEventListener('click', function () {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);

        const icon = this.querySelector('i');
        icon.classList.toggle('fa-eye');
        icon.classList.toggle('fa-eye-slash');
      });

      const supabaseClient = window.supabaseClient;

      const statusBox = document.getElementById('statusBox');
      const loginBtn = document.getElementById('loginBtn');

      function setStatus(type, msg) {
        statusBox.className = 'status ' + (type || '');
        statusBox.textContent = msg || '';
        statusBox.style.display = msg ? 'block' : 'none';
      }

      function setLoading(isLoading) {
        loginBtn.disabled = !!isLoading;
        const label = loginBtn.querySelector('span');
        const icon = loginBtn.querySelector('i');
        if (isLoading) {
          label.textContent = 'Signing in…';
          icon.className = 'fas fa-circle-notch fa-spin';
        } else {
          label.textContent = 'Sign In';
          icon.className = 'fas fa-arrow-right';
        }
      }

      function getPostLoginRedirect() {
        const params = new URLSearchParams(window.location.search);
        const returnTo = params.get('returnTo');
        const next = params.get('next');
        const storedReturnTo = localStorage.getItem('returnTo');
        const storedNext = localStorage.getItem('tep_post_login_redirect');
        return returnTo || next || storedReturnTo || storedNext || 'the-toolkit.html';
      }

      function cleanUrl(removeKeys = []) {
        const url = new URL(window.location.href);
        removeKeys.forEach(k => url.searchParams.delete(k));
        window.history.replaceState({}, document.title, url.toString());
      }

      // 1) Show friendly “state” messages (from your redirects)
      (function showQueryMessages(){
        const params = new URLSearchParams(window.location.search);

        if (params.get('check_email') === '1') {
          setStatus('success', 'Account created. Please confirm your email, then sign in.');
        } else if (params.get('reset') === '1') {
          setStatus('success', 'Password updated. You can sign in now.');
          cleanUrl(['reset']);
        } else if (params.get('confirmed') === '1') {
          setStatus('success', 'Email confirmed. You can sign in now.');
          cleanUrl(['confirmed']);
        } else if (params.get('error_description')) {
          setStatus('error', params.get('error_description'));
        }
      })();

      // 2) Handle Supabase email-link callbacks (signup + recovery) on this page
      //    Supabase links often arrive with: ?type=signup|recovery&token_hash=...
      (async function handleEmailLinkCallback(){
        const params = new URLSearchParams(window.location.search);
        const type = params.get('type'); // 'signup' | 'recovery' | 'magiclink' etc
        const token_hash = params.get('token_hash');

        if (!type || !token_hash) return;

        if (!supabaseClient || !supabaseClient.auth) {
          setStatus('error', 'Auth client not ready. Please refresh the page.');
          return;
        }

        setLoading(true);

        try {
          const { data, error } = await supabaseClient.auth.verifyOtp({ type, token_hash });

          if (error) {
            setStatus('error', error.message || 'This link is invalid or has expired.');
            return;
          }

          // If it’s a password recovery link, send them to the update-password page
          if (type === 'recovery') {
            setStatus('success', 'Link verified. Redirecting to set a new password…');
            // keep the URL clean before redirect
            cleanUrl(['type', 'token_hash']);
            setTimeout(() => {
              window.location.href = 'update-password.html';
            }, 700);
            return;
          }

          // For email confirmation (signup), keep them on TEP and let them sign in
          setStatus('success', 'Email confirmed successfully. You can sign in now.');
          cleanUrl(['type', 'token_hash']);

        } catch (e) {
          console.error(e);
          setStatus('error', 'Something went wrong verifying your link. Please request a new one.');
        } finally {
          setLoading(false);
        }
      })();

      // 3) Normal sign-in
      document.getElementById('loginForm').addEventListener('submit', async function (e) {
        e.preventDefault();
        setStatus('', '');
        setLoading(true);

        if (!supabaseClient || !supabaseClient.auth) {
          setStatus('error', 'Supabase client not found. Check assets/supabaseClient.js is loading correctly.');
          setLoading(false);
          return;
        }

        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;

        try {
          const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });

          if (error) {
            const msg = (error.message || '').toLowerCase().includes('email not confirmed')
              ? 'Please confirm your email first. Check your inbox (and spam).'
              : (error.message || 'Sign-in failed. Please check your details.');
            setStatus('error', msg);
            return;
          }

          if (!data || !data.session) {
            setStatus('error', 'Signed in, but no session was returned. Check your Supabase auth settings.');
            return;
          }

          setStatus('success', 'Signed in successfully. Redirecting…');

          localStorage.removeItem('returnTo');
          localStorage.removeItem('tep_post_login_redirect');

          window.location.href = getPostLoginRedirect();

        } catch (err) {
          console.error(err);
          setStatus('error', 'Something went wrong. Please try again.');
        } finally {
          setLoading(false);
        }
      });
    });
  </script>

</body>
</html>
