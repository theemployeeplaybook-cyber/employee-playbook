<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Micromanagement Framework | The Employee Playbook</title>

  <!-- ICONS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- FONTS -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="assets/img/favicon.png">
  <link rel="icon" type="image/png" href="assets/img/favicon.png">

  <!-- THEME PRELOAD (prevents flash; CSS expects body.dark-mode) -->
  <script>
    (function () {
      try {
        const saved = localStorage.getItem('theme'); // "dark" | "light" | null
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const useDark = saved ? saved === 'dark' : prefersDark;
        if (useDark) document.documentElement.classList.add('preload-dark');
      } catch (e) {}
    })();
  </script>

  <!-- Supabase project config (YOU maintain keys in this file) -->
  <script src="assets/supabase-config.js"></script>
  <!-- Supabase JS (v2) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    /* ===========================
       ROOT VARIABLES (Brand)
    =========================== */
    :root {
      --primary-white: #FFFFFF;
      --light-gray: #F8F9FA;
      --medium-gray: #E9ECEF;
      --dark-gray: #6C757D;
      --text-dark: #212529;
      --text-medium: #495057;

      --accent-purple: #7B5FC4;
      --accent-purple-dark: #5A4496;
      --light-purple: #E6E0F5;
      --lighter-purple: #F0EBFA;

      --border-light: rgba(0, 0, 0, 0.08);
      --nav-bg: rgba(255, 255, 255, 0.95);
      --hero-bg: linear-gradient(135deg, #F9F6FF 0%, #F0EBFA 100%);
      --premium-gradient: linear-gradient(135deg, #7B5FC4 0%, #5A4496 100%);

      --success-green: #10b981;
      --warning-orange: #f59e0b;
      --danger-red: #ef4444;
      --info-blue: #3b82f6;

      /* ===========================
         CATEGORY NAMES + COLOURS (UPDATED)
         (From your category pills file)
      =========================== */
      --category-clarity: #7B5FC4;
      --category-burnout: #f59e0b;
      --category-manager: #10b981;
      --category-politics: #3b82f6;
      --category-hr: #6D28D9;
      --category-confidence: #ef4444;
      --category-career: #800020;

      --pill-clarity-bg: linear-gradient(135deg, rgba(123, 95, 196, 0.08), rgba(123, 95, 196, 0.04));
      --pill-clarity-border: rgba(123, 95, 196, 0.2);
      --pill-clarity-hover-bg: linear-gradient(135deg, rgba(123, 95, 196, 0.12), rgba(123, 95, 196, 0.08));
      --pill-clarity-hover-border: rgba(123, 95, 196, 0.3);

      --pill-burnout-bg: linear-gradient(135deg, rgba(245, 158, 11, 0.08), rgba(245, 158, 11, 0.04));
      --pill-burnout-border: rgba(245, 158, 11, 0.2);
      --pill-burnout-hover-bg: linear-gradient(135deg, rgba(245, 158, 11, 0.12), rgba(245, 158, 11, 0.08));
      --pill-burnout-hover-border: rgba(245, 158, 11, 0.3);

      --pill-manager-bg: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(16, 185, 129, 0.04));
      --pill-manager-border: rgba(16, 185, 129, 0.2);
      --pill-manager-hover-bg: linear-gradient(135deg, rgba(16, 185, 129, 0.12), rgba(16, 185, 129, 0.08));
      --pill-manager-hover-border: rgba(16, 185, 129, 0.3);

      --pill-politics-bg: linear-gradient(135deg, rgba(59, 130, 246, 0.08), rgba(59, 130, 246, 0.04));
      --pill-politics-border: rgba(59, 130, 246, 0.2);
      --pill-politics-hover-bg: linear-gradient(135deg, rgba(59, 130, 246, 0.12), rgba(59, 130, 246, 0.08));
      --pill-politics-hover-border: rgba(59, 130, 246, 0.3);

      --pill-hr-bg: linear-gradient(135deg, rgba(109, 40, 217, 0.08), rgba(109, 40, 217, 0.04));
      --pill-hr-border: rgba(109, 40, 217, 0.2);
      --pill-hr-hover-bg: linear-gradient(135deg, rgba(109, 40, 217, 0.12), rgba(109, 40, 217, 0.08));
      --pill-hr-hover-border: rgba(109, 40, 217, 0.3);

      --pill-confidence-bg: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(239, 68, 68, 0.04));
      --pill-confidence-border: rgba(239, 68, 68, 0.2);
      --pill-confidence-hover-bg: linear-gradient(135deg, rgba(239, 68, 68, 0.12), rgba(239, 68, 68, 0.08));
      --pill-confidence-hover-border: rgba(239, 68, 68, 0.3);

      --pill-career-bg: linear-gradient(135deg, rgba(128, 0, 32, 0.08), rgba(128, 0, 32, 0.04));
      --pill-career-border: rgba(128, 0, 32, 0.2);
      --pill-career-hover-bg: linear-gradient(135deg, rgba(128, 0, 32, 0.12), rgba(128, 0, 32, 0.08));
      --pill-career-hover-border: rgba(128, 0, 32, 0.3);
    }

    /* Dark Mode Variables */
    .dark-mode {
      --primary-white: #1a1a1a;
      --light-gray: #2a2a2a;
      --medium-gray: #3a3a3a;
      --dark-gray: #888888;
      --text-dark: #e0e0e0;
      --text-medium: #b0b0b0;

      --accent-purple: #9d86e9;
      --accent-purple-dark: #7b5fc4;
      --light-purple: rgba(123, 95, 196, 0.2);
      --lighter-purple: rgba(123, 95, 196, 0.1);

      --border-light: rgba(255, 255, 255, 0.08);
      --nav-bg: rgba(30, 30, 30, 0.95);
      --hero-bg: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
      --premium-gradient: linear-gradient(135deg, #9d86e9 0%, #7b5fc4 100%);

      /* Dark mode category variants (from your pills file) */
      --category-clarity: #9d86e9;
      --category-burnout: #fbbf24;
      --category-manager: #34d399;
      --category-politics: #60a5fa;
      --category-hr: #8B5CF6;
      --category-confidence: #f87171;
      --category-career: #B03060;

      --pill-clarity-bg: linear-gradient(135deg, rgba(123, 95, 196, 0.15), rgba(123, 95, 196, 0.08));
      --pill-clarity-border: rgba(157, 134, 233, 0.3);
      --pill-clarity-hover-bg: linear-gradient(135deg, rgba(123, 95, 196, 0.2), rgba(123, 95, 196, 0.12));
      --pill-clarity-hover-border: rgba(157, 134, 233, 0.4);

      --pill-burnout-bg: linear-gradient(135deg, rgba(245, 158, 11, 0.15), rgba(245, 158, 11, 0.08));
      --pill-burnout-border: rgba(251, 191, 36, 0.3);
      --pill-burnout-hover-bg: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.12));
      --pill-burnout-hover-border: rgba(251, 191, 36, 0.4);

      --pill-manager-bg: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.08));
      --pill-manager-border: rgba(52, 211, 153, 0.3);
      --pill-manager-hover-bg: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.12));
      --pill-manager-hover-border: rgba(52, 211, 153, 0.4);

      --pill-politics-bg: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(59, 130, 246, 0.08));
      --pill-politics-border: rgba(96, 165, 250, 0.3);
      --pill-politics-hover-bg: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(59, 130, 246, 0.12));
      --pill-politics-hover-border: rgba(96, 165, 250, 0.4);

      --pill-hr-bg: linear-gradient(135deg, rgba(109, 40, 217, 0.15), rgba(109, 40, 217, 0.08));
      --pill-hr-border: rgba(139, 92, 246, 0.3);
      --pill-hr-hover-bg: linear-gradient(135deg, rgba(109, 40, 217, 0.2), rgba(109, 40, 217, 0.12));
      --pill-hr-hover-border: rgba(139, 92, 246, 0.4);

      --pill-confidence-bg: linear-gradient(135deg, rgba(239, 68, 68, 0.15), rgba(239, 68, 68, 0.08));
      --pill-confidence-border: rgba(248, 113, 113, 0.3);
      --pill-confidence-hover-bg: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.12));
      --pill-confidence-hover-border: rgba(248, 113, 113, 0.4);

      --pill-career-bg: linear-gradient(135deg, rgba(128, 0, 32, 0.15), rgba(128, 0, 32, 0.08));
      --pill-career-border: rgba(176, 48, 96, 0.3);
      --pill-career-hover-bg: linear-gradient(135deg, rgba(128, 0, 32, 0.2), rgba(128, 0, 32, 0.12));
      --pill-career-hover-border: rgba(176, 48, 96, 0.4);
    }

    /* ===========================
       GLOBAL STYLES
    =========================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    html { scroll-behavior: smooth; }

    body {
      background-color: var(--primary-white);
      color: var(--text-dark);
      line-height: 1.6;
      overflow-x: hidden;
      opacity: 0;
      transition: opacity 0.4s ease, background-color 0.3s ease, color 0.3s ease;
      min-height: 100vh;
    }

    html.preload-dark body { background-color: #1a1a1a; color: #e0e0e0; }
    body.loaded { opacity: 1; }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* ===========================
       NAVIGATION (POST-LOGIN HEADER) - UPDATED
    =========================== */
    nav {
      position: fixed;
      top: 0;
      width: 100%;
      background: var(--nav-bg);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      z-index: 1000;
      border-bottom: 1px solid var(--border-light);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: background-color 0.3s ease, border-color 0.3s ease;
      height: 80px;
    }

    .nav-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      height: 100%;
    }

    .logo { display: block; text-decoration: none; }

    .logo-img {
      height: 100px;
      width: auto;
      transform: translateX(20%);
      padding: 14px 10px;
      transition: all 0.3s ease;
      display: block;
      min-height: 100px;
    }

    .logo-fallback {
      display: none;
      font-size: 24px;
      font-weight: 700;
      color: var(--text-dark);
      text-decoration: none;
    }

    .nav-links {
      display: flex;
      gap: 50px;
      transform: translateX(-28px);
    }

    .nav-link {
      color: var(--text-dark);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
      font-size: 17px;
      position: relative;
    }

    .nav-link:hover { color: var(--accent-purple); }

    .nav-link.active { color: var(--text-dark); }
    .nav-link.active::after {
      content: '';
      position: absolute;
      bottom: -7px;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--accent-purple);
      border-radius: 2px 2px 0 0;
    }

    .nav-link-container { position: relative; display: inline-block; }

    .new-tag {
      position: absolute;
      top: -12px;
      right: -35px;
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #000;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 10;
      white-space: nowrap;
    }

    .dark-mode .new-tag { box-shadow: 0 2px 4px rgba(0,0,0,0.4); }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: 14px;
      transform: translateX(calc(-30% - 15px));
    }

    .user-initials {
      width: 38px;
      height: 38px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      font-weight: 700;
      font-size: 13px;
      letter-spacing: 0.5px;
      color: var(--text-dark);
      background: var(--primary-white);
      border: 1px solid var(--border-light);
      transition: all 0.25s ease;
      user-select: none;
      flex: 0 0 auto;
    }

    .user-initials:hover {
      transform: translateY(-1px);
      border-color: rgba(123, 95, 196, 0.35);
      box-shadow: 0 8px 18px rgba(123, 95, 196, 0.12);
      color: var(--accent-purple);
    }

    .dark-mode .user-initials {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.12);
      color: var(--text-dark);
    }

    .dark-mode .user-initials:hover {
      border-color: rgba(139,108,230,0.35);
      box-shadow: 0 10px 22px rgba(139,108,230,0.14);
      color: var(--accent-purple);
    }

    .logout-link {
      display: none;
      font-size: 13px;
      font-weight: 700;
      color: var(--text-medium);
      text-decoration: none;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-light);
      background: rgba(255,255,255,0.7);
      transition: all .2s ease;
      cursor: pointer;
      user-select: none;
    }
    .logout-link:hover {
      transform: translateY(-1px);
      border-color: rgba(123, 95, 196, 0.35);
      color: var(--accent-purple-dark);
      box-shadow: 0 8px 18px rgba(123, 95, 196, 0.10);
    }
    .dark-mode .logout-link {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.12);
      color: var(--text-medium);
    }

    .theme-toggle {
      background: none;
      border: none;
      color: var(--text-dark);
      cursor: pointer;
      font-size: 16px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
    }
    .theme-toggle:hover { background-color: var(--light-gray); }

    .mobile-toggle {
      display: none;
      background: none;
      border: none;
      color: var(--text-dark);
      cursor: pointer;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
    }
    .mobile-toggle:hover { background-color: var(--light-gray); }

    .mobile-profile {
      display: none;
      margin-top: 10px;
      padding: 12px 20px;
      background: var(--accent-purple);
      color: white;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      text-decoration: none;
    }

    .mobile-cta-tab {
      display: none;
      position: fixed;
      top: 50%;
      right: 0;
      transform: translateY(-50%) rotate(-90deg);
      transform-origin: right bottom;
      background: var(--accent-purple);
      color: white;
      padding: 12px 20px;
      border-radius: 8px 8px 0 0;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      box-shadow: 0 5px 15px rgba(123, 95, 196, 0.4);
      z-index: 998;
      transition: all 0.3s ease;
      white-space: nowrap;
    }
    .mobile-cta-tab:hover { background: var(--accent-purple-dark); }

    @media (max-width: 992px) {
      .nav-links { gap: 30px; }
      .nav-actions { gap: 12px; }
    }

    @media (max-width: 768px) {
      .nav-container { justify-content: center; position: relative; }

      .logo {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        height: 100%;
      }

      .logo-img {
        height: 125px;
        transform: none;
        padding: 12px 0;
      }

      .mobile-toggle {
        display: flex;
        position: absolute;
        left: 20px;
        align-items: center;
      }

      .nav-actions {
        transform: none;
        gap: 12px;
        position: absolute;
        right: 20px;
        align-items: center;
      }

      .nav-actions .user-initials { display: none; }
      .nav-actions .logout-link { display: none !important; }

      .nav-links {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background: var(--nav-bg);
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        flex-direction: column;
        padding: 20px;
        border-top: 1px solid var(--border-light);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        gap: 20px;
        transform: none;
      }

      .nav-links.active { display: flex; }
      .nav-link-container { display: flex; width: 100%; }
      .new-tag { position: static; margin-left: 8px; }

      .mobile-profile { display: block !important; }
      .mobile-cta-tab { display: block; }
    }

    /* ===========================
       HERO
    =========================== */
    .tool-hero-section {
      width: 100%;
      background: var(--hero-bg);
      padding: 20px 0 30px;
      margin-top: 110px;
      position: relative;
      border-bottom: 1px solid var(--border-light);
      overflow: hidden;
    }

    .tool-hero-section::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; height: 100%;
      background: linear-gradient(135deg, rgba(250, 245, 255, 0.85) 0%, rgba(245, 240, 255, 0.6) 50%, rgba(255, 255, 255, 0.25) 100%);
      z-index: 1;
    }

    .dark-mode .tool-hero-section::before {
      background: linear-gradient(135deg, rgba(42, 42, 42, 0.9) 0%, rgba(31, 31, 31, 0.7) 50%, rgba(26, 26, 26, 0.4) 100%);
    }

    .tool-hero-content {
      position: relative;
      z-index: 2;
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px 10px;
      animation: heroFadeUp 0.45s ease-out;
    }

    @keyframes heroFadeUp {
      from { opacity: 0; transform: translateY(18px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .breadcrumb {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--dark-gray);
      margin-bottom: 10px;
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .breadcrumb a {
      color: var(--text-medium);
      text-decoration: none !important;
      font-weight: 500;
      letter-spacing: 0.5px;
      transition: color 0.2s ease;
    }

    .breadcrumb a:hover { color: var(--accent-purple-dark); }
    .breadcrumb i { color: var(--dark-gray); opacity: 0.8; }
    .breadcrumb .current { color: var(--text-dark); font-weight: 600; }

    .save-btn {
      position: absolute;
      top: 16px;
      right: 24px;
      z-index: 5;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 999px;
      border: 1px solid rgba(123, 95, 196, 0.6);
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      color: var(--accent-purple-dark);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .save-btn i { font-size: 13px; }

    .save-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(123, 95, 196, 0.18);
      background: #ffffff;
    }

    .dark-mode .save-btn {
      background: rgba(20, 20, 20, 0.9);
      border-color: rgba(157, 134, 233, 0.6);
      color: var(--accent-purple);
    }

    .save-btn.saved {
      background: var(--accent-purple);
      color: #ffffff;
      border-color: transparent;
    }

    .checklist-name {
      font-size: 14px;
      font-weight: 700;
      color: var(--accent-purple);
      text-transform: uppercase;
      letter-spacing: 1.8px;
      margin: 18px 0 12px;
      display: block;
    }

    .hero-main-heading {
      font-size: 46px;
      font-weight: 650;
      color: var(--text-dark);
      line-height: 1.1;
      margin-bottom: 18px;
      max-width: 1000px;
    }

    .hero-subheading {
      font-size: 16px;
      color: var(--text-medium);
      line-height: 1.6;
      max-width: 980px;
      margin-bottom: 26px;
    }

    /* ===========================
       CATEGORY PILLS (UPDATED)
    =========================== */
    .category-pills-container { margin-bottom: 10px; }
    .category-pills-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-medium);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 12px;
      display: block;
    }

    .category-pills-grid {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .category-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid transparent;
      text-decoration: none;
      height: 32px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
      cursor: pointer;
      white-space: nowrap;
    }

    .category-pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
      text-decoration: none;
    }

    .category-icon { font-size: 12px; opacity: 0.9; flex-shrink: 0; }

    .category-pill.clarity { color: var(--category-clarity); border-color: var(--pill-clarity-border); background: var(--pill-clarity-bg); }
    .category-pill.clarity:hover { background: var(--pill-clarity-hover-bg); border-color: var(--pill-clarity-hover-border); }

    .category-pill.burnout { color: var(--category-burnout); border-color: var(--pill-burnout-border); background: var(--pill-burnout-bg); }
    .category-pill.burnout:hover { background: var(--pill-burnout-hover-bg); border-color: var(--pill-burnout-hover-border); }

    .category-pill.manager { color: var(--category-manager); border-color: var(--pill-manager-border); background: var(--pill-manager-bg); }
    .category-pill.manager:hover { background: var(--pill-manager-hover-bg); border-color: var(--pill-manager-hover-border); }

    .category-pill.politics { color: var(--category-politics); border-color: var(--pill-politics-border); background: var(--pill-politics-bg); }
    .category-pill.politics:hover { background: var(--pill-politics-hover-bg); border-color: var(--pill-politics-hover-border); }

    .category-pill.hr { color: var(--category-hr); border-color: var(--pill-hr-border); background: var(--pill-hr-bg); }
    .category-pill.hr:hover { background: var(--pill-hr-hover-bg); border-color: var(--pill-hr-hover-border); }

    .category-pill.confidence { color: var(--category-confidence); border-color: var(--pill-confidence-border); background: var(--pill-confidence-bg); }
    .category-pill.confidence:hover { background: var(--pill-confidence-hover-bg); border-color: var(--pill-confidence-hover-border); }

    .category-pill.career { color: var(--category-career); border-color: var(--pill-career-border); background: var(--pill-career-bg); }
    .category-pill.career:hover { background: var(--pill-career-hover-bg); border-color: var(--pill-career-hover-border); }

    /* ===========================
       CONTEXT & PRO TIPS
    =========================== */
    .context-tips-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      margin-bottom: 40px;
      width: 100%;
      max-width: 1100px;
      margin: 0 auto 50px;
      padding: 24px 20px 10px;
      margin-top: 6px;
    }

    .context-card, .tips-card {
      background: var(--primary-white);
      border: 1px solid var(--border-light);
      border-radius: 14px;
      padding: 28px 30px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.05);
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-title i { color: var(--accent-purple); }

    .bullet-list { list-style: none; margin: 0; padding: 0; }
    .bullet-list li {
      color: var(--text-medium);
      line-height: 1.65;
      margin-bottom: 12px;
      padding-left: 26px;
      position: relative;
      font-size: 14.5px;
      font-weight: 450;
    }
    .bullet-list li::before {
      content: "•";
      position: absolute;
      left: 10px;
      color: var(--accent-purple);
      font-size: 18px;
    }

    /* ===========================
       CHECKLIST BODY
    =========================== */
    .checklist-body {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px 20px;
    }

    .checklist-section-title {
      font-size: 26px;
      font-weight: 750;
      color: var(--accent-purple-dark);
      margin: 56px 0 18px;
    }

    .checklist-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
      counter-reset: tepStep;
    }

    .checklist-item {
      position: relative;
      background: var(--primary-white);
      padding: 14px 16px 14px 52px;
      border-radius: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      border: 1px solid var(--border-light);
      display: flex;
      gap: 12px;
      align-items: flex-start;
      transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease;
      cursor: pointer;
      height: 100%;
      min-height: 72px;
      outline: none;
    }

    .checklist-item:focus-visible {
      box-shadow: 0 0 0 3px rgba(123, 95, 196, 0.25), 0 1px 4px rgba(0,0,0,0.06);
      border-color: rgba(123, 95, 196, 0.35);
    }

    .checklist-item::before {
      counter-increment: tepStep;
      content: counter(tepStep);
      position: absolute;
      left: 14px;
      top: 14px;
      width: 28px;
      height: 28px;
      border-radius: 10px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
      color: var(--accent-purple-dark);
      background: linear-gradient(135deg, rgba(123, 95, 196, 0.16), rgba(123, 95, 196, 0.06));
      border: 1px solid rgba(123, 95, 196, 0.22);
    }

    .dark-mode .checklist-item::before {
      color: var(--accent-purple);
      background: linear-gradient(135deg, rgba(123, 95, 196, 0.22), rgba(123, 95, 196, 0.10));
      border-color: rgba(157, 134, 233, 0.30);
    }

    .checklist-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 26px rgba(0,0,0,0.08);
      border-color: rgba(123, 95, 196, 0.25);
    }

    .checklist-item i {
      color: var(--accent-purple);
      font-size: 18px;
      margin-top: 3px;
      flex-shrink: 0;
    }

    .checklist-text {
      flex: 1;
      color: var(--text-medium);
      font-size: 14.6px;
      line-height: 1.55;
      font-weight: 450;
    }

    /* ===========================
       LEFT STEP SIDEBAR
    =========================== */
    .step-sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      z-index: 1185;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.22s ease;
    }

    .step-sidebar-overlay.open { opacity: 1; pointer-events: auto; }

    .step-sidebar {
      position: fixed;
      top: 0;
      left: -420px;
      width: 390px;
      max-width: 92vw;
      height: 100%;
      z-index: 1186;
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      border-right: 1px solid var(--border-light);
      box-shadow: 6px 0 26px rgba(0,0,0,0.18);
      transition: left 0.24s ease;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .dark-mode .step-sidebar {
      background: rgba(18, 18, 18, 0.96);
      box-shadow: 8px 0 28px rgba(0,0,0,0.55);
    }

    .step-sidebar.open { left: 0; }

    .step-sidebar-topbar {
      padding: 18px 18px 14px;
      border-bottom: 1px solid var(--border-light);
      position: relative;
    }

    .step-sidebar-topbar::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 3px;
      background: var(--premium-gradient);
    }

    .step-top-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 10px;
    }

    .step-chip {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 12px;
      background: rgba(123, 95, 196, 0.10);
      border: 1px solid rgba(123, 95, 196, 0.18);
      width: 100%;
    }

    .dark-mode .step-chip {
      background: rgba(123, 95, 196, 0.18);
      border-color: rgba(157, 134, 233, 0.22);
    }

    .step-badge {
      width: 32px;
      height: 32px;
      border-radius: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 12px;
      color: #fff;
      background: var(--premium-gradient);
      flex-shrink: 0;
      box-shadow: 0 10px 22px rgba(123, 95, 196, 0.22);
    }

    .step-chip-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .step-chip-title {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-dark);
      line-height: 1.2;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .step-chip-sub {
      font-size: 12px;
      color: var(--text-medium);
      font-weight: 500;
    }

    .step-close-btn {
      background: none;
      border: none;
      color: var(--dark-gray);
      cursor: pointer;
      font-size: 18px;
      border-radius: 999px;
      width: 34px;
      height: 34px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
      flex-shrink: 0;
    }

    .step-close-btn:hover { background: var(--light-gray); }

    .step-sidebar-body {
      padding: 14px 16px 18px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .step-card {
      background: var(--primary-white);
      border: 1px solid var(--border-light);
      border-radius: 14px;
      padding: 14px 14px;
      box-shadow: 0 10px 26px rgba(0,0,0,0.05);
    }

    .dark-mode .step-card { box-shadow: 0 12px 28px rgba(0,0,0,0.28); }

    .step-card-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.6px;
      text-transform: uppercase;
      color: var(--accent-purple-dark);
      margin-bottom: 8px;
    }

    .step-card p,
    .step-card li {
      font-size: 13.5px;
      color: var(--text-medium);
      line-height: 1.6;
      font-weight: 450;
    }

    .step-mini-list {
      list-style: none;
      margin: 8px 0 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .step-mini-list li {
      padding-left: 22px;
      position: relative;
    }

    .step-mini-list li::before {
      content: "•";
      position: absolute;
      left: 8px;
      top: 0;
      color: var(--accent-purple);
      font-size: 16px;
      line-height: 1.2;
    }

    .step-sidebar-footer {
      padding: 12px 16px 16px;
      border-top: 1px solid var(--border-light);
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      background: rgba(255,255,255,0.7);
    }

    .dark-mode .step-sidebar-footer { background: rgba(18,18,18,0.7); }

    .step-footer-btn {
      border: none;
      padding: 10px 12px;
      border-radius: 12px;
      font-weight: 750;
      font-size: 13px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: transform 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
    }

    .step-footer-btn.primary {
      background: var(--premium-gradient);
      color: #fff;
      box-shadow: 0 12px 26px rgba(123,95,196,0.22);
    }

    .step-footer-btn.primary:hover { transform: translateY(-1px); box-shadow: 0 16px 30px rgba(123,95,196,0.28); }

    .step-footer-btn.secondary {
      background: var(--light-purple);
      color: var(--accent-purple-dark);
    }

    .dark-mode .step-footer-btn.secondary {
      background: rgba(123, 95, 196, 0.22);
      color: var(--accent-purple);
    }

    .step-footer-btn.secondary:hover {
      transform: translateY(-1px);
      background: rgba(123, 95, 196, 0.18);
    }

    .step-footer-btn:disabled {
      opacity: 0.55;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    /* ===========================
       SCORE
    =========================== */
    .clarity-score-section {
      max-width: 1100px;
      margin: 25px auto 40px;
      padding: 0 20px;
    }

    .presence-snapshot-header { margin-bottom: 18px; text-align: left; }
    .presence-snapshot-header h2 {
      font-size: 22px;
      font-weight: 700;
      color: var(--accent-purple-dark);
      margin-bottom: 6px;
    }
    .presence-snapshot-header p {
      font-size: 14px;
      color: var(--text-medium);
      max-width: 1100px;
      line-height: 1.55;
      font-weight: 450;
    }

    .clarity-score-bar {
      display: flex;
      align-items: stretch;
      gap: 30px;
      background: var(--primary-white);
      border-radius: 16px;
      padding: 22px 24px 20px;
      box-shadow: 0 14px 40px rgba(123, 95, 196, 0.12);
      border: 1px solid rgba(123, 95, 196, 0.15);
    }

    .clarity-progress-container { flex: 1.4; }

    .clarity-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
    }

    .clarity-title { font-size: 18px; font-weight: 700; color: var(--accent-purple-dark); }
    .clarity-percentage { font-size: 28px; font-weight: 600; color: var(--accent-purple); }

    .progress-container {
      height: 10px;
      background: var(--light-gray);
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 6px;
    }

    .dark-mode .progress-container { background: rgba(255, 255, 255, 0.12); }

    .progress-fill {
      height: 100%;
      background: var(--premium-gradient);
      width: 0%;
      border-radius: 5px;
      transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .progress-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--dark-gray);
    }

    .presence-dimensions {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 14px;
    }

    .presence-dimension-pill {
      border-radius: 12px;
      padding: 8px 10px;
      border: 1px solid var(--border-light);
      background: var(--light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--text-medium);
    }

    .dark-mode .presence-dimension-pill {
      background: rgba(255,255,255,0.04);
      border-color: rgba(255,255,255,0.1);
    }

    .presence-dimension-pill span.label { font-weight: 750; color: var(--text-dark); }
    .presence-dimension-pill span.score { font-weight: 600; color: var(--accent-purple); }

    .actions-container {
      display: flex;
      gap: 12px;
      flex-shrink: 0;
      flex-direction: column;
      justify-content: center;
      align-items: stretch;
      max-width: 260px;
    }

    .action-btn {
      background: var(--premium-gradient);
      color: white;
      border: none;
      padding: 10px 18px;
      font-size: 13.5px;
      border-radius: 12px;
      font-weight: 750;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.25s ease;
      width: 100%;
      justify-content: center;
    }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 26px rgba(123, 95, 196, 0.28);
    }

    .action-btn.secondary {
      background: var(--light-purple);
      color: var(--accent-purple-dark);
    }

    .dark-mode .action-btn.secondary {
      background: rgba(123, 95, 196, 0.21);
      color: var(--accent-purple);
    }

    .action-btn.secondary:hover { background: var(--accent-purple); color: white; }
    .action-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

    .progress-fill.high { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .progress-fill.medium { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .progress-fill.low { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }

    /* ===========================
       SAVE PROGRESS STATUS
    =========================== */
    .save-progress-status {
      font-size: 12px;
      text-align: center;
      margin-top: 2px;
      min-height: 16px;
      line-height: 1.2;
      color: var(--dark-gray);
    }

    /* ===========================
       SMART SUMMARY
    =========================== */
    .smart-summary-section {
      max-width: 1100px;
      margin: 0 auto 30px;
      padding: 0 20px;
      display: none;
    }

    .smart-summary-section.active {
      display: block;
      animation: slideIn 0.5s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .summary-header { text-align: center; margin-bottom: 28px; }
    .summary-title { font-size: 24px; font-weight: 700; color: var(--accent-purple-dark); margin-bottom: 6px; }
    .summary-subtitle { color: var(--text-medium); font-size: 15px; margin-bottom: 8px; font-weight: 450; }
    .summary-insight { font-size: 13.5px; color: var(--dark-gray); max-width: 760px; margin: 0 auto; line-height: 1.6; }

    .section-header {
      font-size: 18px;
      font-weight: 700;
      margin: 26px 0 18px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--light-gray);
    }

    .section-header.red { color: var(--danger-red); }
    .section-header.purple { color: var(--accent-purple-dark); }
    .section-header.blue { color: var(--accent-purple); }

    .manager-type-wrap {
      display: grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap: 18px;
      margin-bottom: 12px;
    }

    .manager-type-card,
    .manager-handling-card {
      background: var(--primary-white);
      border-radius: 14px;
      padding: 18px;
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 14px 30px rgba(0,0,0,0.06);
      position: relative;
      overflow: hidden;
    }

    .dark-mode .manager-type-card,
    .dark-mode .manager-handling-card {
      border-color: rgba(255,255,255,0.08);
      box-shadow: 0 18px 34px rgba(0,0,0,0.32);
    }

    .manager-type-card::before,
    .manager-handling-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: var(--premium-gradient);
    }

    .mt-title {
      font-size: 12px;
      font-weight: 700;
      letter-spacing: 0.7px;
      text-transform: uppercase;
      color: var(--accent-purple-dark);
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }

    .mt-name {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 6px;
      line-height: 1.25;
    }

    .mt-desc {
      color: var(--text-medium);
      font-size: 13.5px;
      line-height: 1.6;
      font-weight: 450;
    }

    .mt-list {
      list-style: none;
      margin: 10px 0 0;
      padding: 0;
      display: grid;
      gap: 8px;
    }

    .mt-list li {
      position: relative;
      padding-left: 22px;
      color: var(--text-medium);
      font-size: 13.5px;
      line-height: 1.55;
      font-weight: 450;
    }

    .mt-list li::before {
      content: "•";
      position: absolute;
      left: 8px;
      top: 0;
      color: var(--accent-purple);
      font-size: 16px;
      line-height: 1.2;
    }

    .red-flags-grid,
    .next-steps-grid,
    .resources-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 20px;
    }

    .red-flag-card,
    .next-step-card,
    .resource-card {
      background: var(--primary-white);
      border-radius: 14px;
      padding: 18px;
      border: 1px solid rgba(0,0,0,0.06);
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
      box-shadow: 0 14px 30px rgba(0,0,0,0.06);
    }

    .dark-mode .red-flag-card,
    .dark-mode .next-step-card,
    .dark-mode .resource-card {
      border-color: rgba(255,255,255,0.08);
      box-shadow: 0 18px 34px rgba(0,0,0,0.32);
    }

    .red-flag-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    .next-step-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--premium-gradient); }
    .resource-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; background: var(--premium-gradient); }

    .flag-icon, .step-icon, .resource-icon {
      font-size: 18px;
      margin-bottom: 14px;
      width: 40px;
      height: 40px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .flag-icon { color: #ef4444; background: rgba(239, 68, 68, 0.10); }
    .step-icon, .resource-icon { color: var(--accent-purple); background: var(--lighter-purple); }

    .flag-title, .step-title, .resource-title { font-size: 15px; font-weight: 700; color: var(--text-dark); margin-bottom: 8px; }
    .flag-description, .step-description, .resource-description { color: var(--text-medium); font-size: 13.5px; line-height: 1.55; flex-grow: 1; font-weight: 450; }

    .resource-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .resource-card:hover { transform: translateY(-3px); box-shadow: 0 18px 34px rgba(123, 95, 196, 0.14); }

    .resource-link {
      color: var(--accent-purple);
      font-weight: 600;
      text-decoration: none;
      font-size: 13.5px;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: auto;
    }

    .resource-link:hover { text-decoration: underline; }

    /* ===========================
       CLOSURE
    =========================== */
    .closure-section {
      max-width: 1100px;
      margin: 0 auto 60px;
      padding: 0 20px;
      display: none;
    }
    .closure-section.active { display: block; animation: slideIn 0.5s ease; }

    .closure-card{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap: 28px;
      align-items:start;
      padding: 28px;
      border-radius: 22px;
      border: 1px solid rgba(123,95,196,0.18);
      background: linear-gradient(180deg, rgba(123,95,196,0.06), rgba(123,95,196,0.02));
      box-shadow: 0 12px 30px rgba(10,10,20,0.06);
    }

    .closure-title{
      display:flex;
      align-items:center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .closure-title i{
      color: var(--accent-purple);
      font-size: 18px;
    }

    .closure-title h3{
      margin:0;
      font-size: 20px;
      letter-spacing: -0.2px;
      font-weight: 650;
      color: var(--text-dark);
    }

    .closure-lead{
      margin: 0 0 14px;
      color: var(--text-medium);
      max-width: 72ch;
      font-weight: 450;
    }

    .closure-list{
      list-style:none;
      margin:0;
      padding:0;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .closure-list li{
      display:flex;
      gap: 10px;
      align-items:flex-start;
      color: var(--text-dark);
      font-size: 13.7px;
      line-height: 1.55;
      font-weight: 450;
    }

    .closure-list .dot{
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--accent-purple);
      margin-top: 9px;
      flex: 0 0 auto;
      opacity: .85;
    }

    .closure-right{ align-self:start; }

    .tip-card{
      align-self:start;
      background: var(--primary-white);
      border: 1px solid var(--border-light);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 10px 22px rgba(10,10,20,0.05);
    }

    .tip-head{
      display:flex;
      align-items:center;
      gap: 10px;
      font-weight: 750;
      letter-spacing: 0.12em;
      font-size: 12px;
      color: var(--accent-purple-dark);
      margin-bottom: 10px;
    }

    .tip-head i{ font-size: 14px; color: var(--accent-purple); }

    .tip-body{
      margin:0;
      color: var(--text-dark);
      line-height: 1.55;
      font-weight: 450;
      font-size: 13.5px;
    }

    @media (max-width: 980px){
      .closure-card{ grid-template-columns: 1fr; }
    }

    /* ===========================
       MY PLAYBOOK FAB + SIDEBAR (Right)
    =========================== */
    .my-playbook-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1200;
      background: var(--premium-gradient);
      color: #ffffff;
      padding: 10px 16px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 750;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
      transition: all 0.25s ease;
    }

    .my-playbook-fab:hover {
      transform: translateY(-3px);
      box-shadow: 0 14px 30px rgba(0,0,0,0.32);
    }

    .playbook-sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 1190;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }

    .playbook-sidebar-overlay.open { opacity: 1; pointer-events: auto; }

    .playbook-sidebar {
      position: fixed;
      top: 0;
      right: -380px;
      width: 340px;
      max-width: 90%;
      height: 100%;
      background: rgba(255, 255, 255, 0.94);
      backdrop-filter: blur(18px);
      -webkit-backdrop-filter: blur(18px);
      box-shadow: -4px 0 20px rgba(0,0,0,0.25);
      z-index: 1191;
      display: flex;
      flex-direction: column;
      border-left: 1px solid var(--border-light);
      transition: right 0.25s ease;
    }

    .dark-mode .playbook-sidebar { background: rgba(18, 18, 18, 0.96); box-shadow: -4px 0 22px rgba(0,0,0,0.6); }
    .playbook-sidebar.open { right: 0; }

    .playbook-sidebar-header {
      padding: 20px 20px 14px;
      border-bottom: 1px solid var(--border-light);
    }

    .playbook-sidebar-header-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .playbook-sidebar-header h3 { font-size: 18px; font-weight: 700; color: var(--text-dark); }
    .playbook-sidebar-header p { font-size: 13px; color: var(--dark-gray); }

    .playbook-close-btn {
      background: none;
      border: none;
      color: var(--dark-gray);
      cursor: pointer;
      font-size: 18px;
      border-radius: 999px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
    }

    .playbook-close-btn:hover { background: var(--light-gray); }

    .playbook-sidebar-body {
      padding: 14px 18px 20px;
      padding-bottom: 50px;
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .saved-items-empty { font-size: 13px; color: var(--dark-gray); line-height: 1.6; }
    .saved-items-list { list-style: none; margin: 0; padding: 0; }

    .saved-item {
      padding: 10px 10px 10px;
      border-radius: 12px;
      border: 1px solid var(--border-light);
      background: var(--primary-white);
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .saved-item-title-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
    }

    .saved-item-title { font-size: 14px; font-weight: 700; color: var(--text-dark); }
    .saved-item-type {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--accent-purple-dark);
      font-weight: 600;
    }

    .saved-item-meta { font-size: 12px; color: var(--dark-gray); }

    .saved-item-actions {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-top: 6px;
    }

    .saved-item-link {
      font-size: 12px;
      color: var(--accent-purple);
      text-decoration: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .saved-item-link:hover { text-decoration: underline; }

    .saved-item-remove {
      border: 1px solid rgba(239,68,68,0.28);
      background: rgba(239,68,68,0.08);
      color: #ef4444;
      padding: 6px 10px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 11px;
      cursor: pointer;
      transition: transform .15s ease, box-shadow .15s ease, background-color .15s ease;
      white-space: nowrap;
    }
    .saved-item-remove:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 20px rgba(239,68,68,0.12);
      background: rgba(239,68,68,0.12);
    }

    .playbook-quick-links {
      margin-top: 223px;
      padding-top: 10px;
      border-top: 1px solid var(--border-light);
    }

    .quick-links-title {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-medium);
    }

    .playbook-quick-links-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 8px;
    }

    .quick-link-pill {
      width: 49%;
      margin-left: auto;
      margin-right: auto;
      padding: 8px 12px;
      border-radius: 999px;
      border: 1px solid rgba(123, 95, 196, 0.35);
      background: linear-gradient(135deg,rgba(123, 95, 196, 0.08),rgba(123, 95, 196, 0.02));
      text-decoration: none;
      color: var(--accent-purple-dark);
      font-size: 13px;
      font-weight: 650;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .quick-link-pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(0,0,0,0.12);
      background: linear-gradient(135deg,rgba(123, 95, 196, 0.16), rgba(123, 95, 196, 0.06));
    }

    .dark-mode .quick-link-pill {
      border-color: rgba(157, 134, 233, 0.55);
      background: linear-gradient(135deg,rgba(123, 95, 196, 0.26),rgba(123, 95, 196, 0.12));
    }

    /* ===========================
       FOOTER
    =========================== */
    footer {
      background: var(--primary-white);
      padding: 10px 0;
      border-top: 1px solid var(--border-light);
      margin-top: 30px;
      text-align: center;
      color: var(--text-medium);
    }

    /* ===========================
       AUTH LOCK OVERLAY
    =========================== */
    .auth-lock-overlay {
      position: fixed;
      inset: 0;
      z-index: 1300;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(0px);
      -webkit-backdrop-filter: blur(0px);
    }

    .auth-lock-overlay.active { display: flex; }

    .auth-lock-card {
      width: min(560px, 100%);
      background: var(--primary-white);
      border: 1px solid var(--border-light);
      border-radius: 16px;
      padding: 22px 22px 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.35);
    }

    .dark-mode .auth-lock-card {
      background: rgba(18,18,18,0.96);
      border-color: rgba(255,255,255,0.10);
    }

    .auth-lock-title {
      font-size: 18px;
      font-weight: 900;
      color: var(--text-dark);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .auth-lock-title i { color: var(--accent-purple); }

    .auth-lock-text {
      font-size: 14px;
      color: var(--text-medium);
      line-height: 1.6;
      margin-bottom: 14px;
    }

    .auth-lock-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .auth-lock-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: none;
      cursor: pointer;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 800;
      font-size: 13px;
      text-decoration: none;
      white-space: nowrap;
    }

    .auth-lock-btn.primary { background: var(--premium-gradient); color: #fff; }
    .auth-lock-btn.secondary { background: var(--light-purple); color: var(--accent-purple-dark); }

    .dark-mode .auth-lock-btn.secondary {
      background: rgba(123, 95, 196, 0.21);
      color: var(--accent-purple);
    }

    body.auth-locked .tool-hero-section,
    body.auth-locked .context-tips-grid,
    body.auth-locked .checklist-body,
    body.auth-locked .clarity-score-section,
    body.auth-locked #smartSummary,
    body.auth-locked #closureSection,
    body.auth-locked footer,
    body.auth-locked .my-playbook-fab {
      filter: none;
      opacity: 1;
      user-select: none;
    }

    /* ===========================
       PRINT CSS
    =========================== */
    @media print {
      nav,
      .my-playbook-fab,
      .playbook-sidebar-overlay,
      .mobile-cta-tab,
      .save-btn,
      .actions-container,
      .auth-lock-overlay,
      .step-sidebar-overlay,
      .step-sidebar {
        display: none !important;
      }

      body {
        background: #fff !important;
        color: #000 !important;
        opacity: 1 !important;
      }

      .tool-hero-section {
        margin-top: 0 !important;
        padding-top: 0 !important;
      }

      .tool-hero-section::before { display: none !important; }
      .checklist-item { box-shadow: none !important; }
      footer { border-top: 1px solid #ddd !important; }

      .smart-summary-section.active,
      .closure-section.active { display: block !important; }
    }

    /* ===========================
       RESPONSIVE
    =========================== */
    @media (max-width: 1024px) {
      .context-tips-grid { grid-template-columns: 1fr; gap: 24px; }
      .red-flags-grid, .next-steps-grid, .resources-grid { grid-template-columns: repeat(2, 1fr); }
      .manager-type-wrap { grid-template-columns: 1fr; }
      .checklist-grid { grid-template-columns: 1fr; }
      .clarity-score-bar { flex-direction: column; }
      .actions-container { max-width: 100%; flex-direction: row; }
    }

    @media (max-width: 768px) {
      .tool-hero-section { margin-top: 100px; }
      .hero-main-heading { font-size: 36px; }
      .clarity-score-bar { padding: 18px; }
      .actions-container { flex-direction: column; }
      .red-flags-grid, .next-steps-grid, .resources-grid { grid-template-columns: 1fr; }
      .save-btn { right: 18px; top: 10px; }
      .my-playbook-fab { bottom: 18px; right: 18px; }
      .quick-link-pill { width: 72%; }
    }

    @media (max-width: 480px) {
      .hero-main-heading { font-size: 32px; }
      .checklist-name { font-size: 13px; }
      .presence-dimensions { grid-template-columns: 1fr; }
      .checklist-item { padding-left: 50px; }
      .checklist-item::before { border-radius: 10px; }
      .step-sidebar { width: 92vw; }
      .quick-link-pill { width: 86%; }
    }
  </style>
</head>

<body>

  <!-- Mobile My Playbook tab -->
  <a href="#" class="mobile-cta-tab" id="mobileMyPlaybookTab">My Playbook</a>

  <!-- ===========================
       NAVIGATION (POST-LOGIN)
  =========================== -->
  <nav>
    <div class="container nav-container">
      <button class="mobile-toggle" id="mobileToggle" aria-label="Open menu" aria-expanded="false" aria-controls="navLinks">
        <i class="fas fa-bars"></i>
      </button>

      <a href="index.html" class="logo" aria-label="Home">
        <img src="assets/img/logo.png" alt="The Employee Playbook" class="logo-img" id="mainLogo"
             onerror="this.style.display='none'; document.getElementById('logo-fallback').style.display='block';">
        <div class="logo-fallback" id="logo-fallback">THE EMPLOYEE PLAYBOOK</div>
      </a>

      <div class="nav-links" id="navLinks">
        <a href="the-lens.html" class="nav-link">The Lens</a>
        <a href="the-toolkit.html" class="nav-link active">The Toolkit</a>
        <div class="nav-link-container">
          <a href="the-coach.html" class="nav-link">The Coach</a>
          <span class="new-tag">NEW</span>
        </div>
        <a href="the-shift.html" class="nav-link">The Shift</a>
        <a href="the-pricing.html" class="nav-link">The Pricing</a>

        <a href="profile.html" class="mobile-profile" id="mobileProfileBtn">Profile</a>
      </div>

      <div class="nav-actions">
        <a href="sign-in.html" class="user-initials" id="userInitialsBtn" aria-label="Open profile">…</a>

        <a class="logout-link" id="logoutBtn" href="#" aria-label="Log out">Log out</a>
        <button class="theme-toggle" id="themeToggleBtn" aria-label="Toggle theme">
          <i class="fas fa-moon"></i>
        </button>
      </div>
    </div>
  </nav>

  <!-- ✅ HARD LOCK WRAPPER (inert toggled when locked) -->
  <main id="toolMain">
    <!-- ===========================
         HERO
    =========================== -->
    <div class="tool-hero-section">
      <button class="save-btn" id="saveBtn" type="button">
        <i class="far fa-bookmark"></i>
        <span>Save item</span>
      </button>

      <div class="tool-hero-content">
        <div class="breadcrumb">
          <a href="index.html"><i class="fas fa-house"></i> Home</a>
          <i class="fas fa-chevron-right"></i>
          <a href="the-toolkit.html">Toolkit</a>
          <i class="fas fa-chevron-right"></i>
          <a href="manager-relationship-and-leadership-style.html">Manager Relationship &amp; Leadership Style</a>
          <i class="fas fa-chevron-right"></i>
          <span class="current">Micromanagement Framework</span>
        </div>

        <span class="checklist-name">MICROMANAGEMENT FRAMEWORK</span>

        <h1 class="hero-main-heading">Diagnose the pattern, then choose moves that restore control without a blow-up</h1>

        <div class="hero-subheading">
          Micromanagement is rarely "just a personality". It's usually a control system: visibility demands, decision capture, and trust erosion.
          Identify the type of micromanager you're dealing with, then respond in ways that protect delivery, credibility, and energy.
        </div>

        <div class="category-pills-container">
          <span class="category-pills-title">Related Categories</span>
          <div class="category-pills-grid">
            <a href="category-clarity-priorities-and-direction.html" class="category-pill clarity">
              <i class="fas fa-compass category-icon"></i>
              <span>Clarity, Priorities &amp; Direction</span>
            </a>
            <a href="category-expectation-burnout-and-capacity.html" class="category-pill burnout">
              <i class="fas fa-battery-half category-icon"></i>
              <span>Expectations, Burnout &amp; Capacity</span>
            </a>
            <a href="category-workplace-dynamics-and-politics.html" class="category-pill politics">
              <i class="fas fa-users category-icon"></i>
              <span>Workplace Dynamics and Politics</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- ===========================
         CONTEXT & PRO TIPS
    =========================== -->
    <div class="context-tips-grid">
      <div class="context-card">
        <h3 class="section-title"><i class="fas fa-calendar-check"></i>When to Use This Framework</h3>
        <ul class="bullet-list">
          <li>When your autonomy is shrinking and "updates" have become constant surveillance.</li>
          <li>When decisions are repeatedly reopened, rewritten, or rerouted through your manager.</li>
          <li>When you're working harder but delivering less, because control friction is eating time.</li>
          <li>When you can feel your confidence changing (second-guessing, over-explaining, hesitating).</li>
          <li>When you need to stabilise the situation without escalating into a formal conflict.</li>
        </ul>
      </div>

      <div class="tips-card">
        <h3 class="section-title"><i class="fas fa-lightbulb"></i>Pro Tips</h3>
        <ul class="bullet-list">
          <li>Don't "win the argument". Build an operating rhythm that makes micromanagement unnecessary.</li>
          <li>Use structure as a shield: clear plans, clear checkpoints, and clean decision records.</li>
          <li>Never fight for autonomy with emotion. Ask for it with delivery controls.</li>
          <li>Track patterns, not vibes: what's happening, how often, and what it impacts.</li>
          <li>If the behaviour becomes punitive or reputation-damaging, switch to protection mode early.</li>
        </ul>
      </div>
    </div>

    <!-- ===========================
         CHECKLIST BODY
    =========================== -->
    <div class="checklist-body" id="checklistText">
      <h2 class="checklist-section-title">Micromanagement Signals Checklist</h2>

      <div class="checklist-grid" id="checklistGrid">
        <div class="checklist-item" data-category="visibility" tabindex="0" role="button" aria-pressed="false">
          <i class="far fa-square"></i>
          <div class="checklist-text">
            I'm asked for frequent "quick updates" that don't change decisions, they mainly prove I'm working.
          </div>
        </div>

        <div class="checklist-item" data-category="control" tabindex="0" role="button" aria-pressed="false">
          <i class="far fa-square"></i>
          <div class="checklist-text">
            My manager rewrites my work or messaging, even when the original is correct and fit for purpose.
          </div>
        </div>

        <div class="checklist-item" data-category="trust" tabindex="0" role="button" aria-pressed="false">
          <i class="far fa-square"></i>
          <div class="checklist-text">
            Decisions get pulled back to my manager "for review" after I've already agreed them with stakeholders.
          </div>
        </div>

        <div class="checklist-item" data-category="process" tabindex="0" role="button" aria-pressed="false">
          <i class="far fa-square"></i>
          <div class="checklist-text">
            I'm required to copy them into everything, or get approval for routine actions that shouldn't need it.
          </div>
        </div>

        <div class="checklist-item" data-category="tone" tabindex="0" role="button" aria-pressed="false">
          <i class="far fa-square"></i>
          <div class="checklist-text">
            Feedback focuses on style, wording, or "tone", more than outcomes or impact.
          </div>
        </div>

        <div class="checklist-item" data-category="visibility" tabindex="0" role="button" aria-pressed="false">
          <i class="far fa-square"></i>
          <div class="checklist-text">
            They ask for status even when we agreed a checkpoint, as if they can't tolerate unknowns.
          </div>
        </div>

        <div class="checklist-item" data-category="control" tabindex="0" role="button" aria-pressed="false">
          <i class="far fa-square"></i>
          <div class="checklist-text">
            I'm not allowed to present my own work; they speak for it, then send me to "action it".
          </div>
        </div>

        <div class="checklist-item" data-category="politics" tabindex="0" role="button" aria-pressed="false">
          <i class="far fa-square"></i>
          <div class="checklist-text">
            They manage optics aggressively, who gets credit, who gets access, and what gets seen.
          </div>
        </div>

        <div class="checklist-item" data-category="process" tabindex="0" role="button" aria-pressed="false">
          <i class="far fa-square"></i>
          <div class="checklist-text">
            Work keeps being "refined" with no clear definition of done, it turns into endless iteration.
          </div>
        </div>

        <div class="checklist-item" data-category="hr" tabindex="0" role="button" aria-pressed="false">
          <i class="far fa-square"></i>
          <div class="checklist-text">
            They use policy/process language to control behaviour (e.g., "compliance", "standards"), rather than coaching.
          </div>
        </div>

        <div class="checklist-item" data-category="trust" tabindex="0" role="button" aria-pressed="false">
          <i class="far fa-square"></i>
          <div class="checklist-text">
            My judgement is questioned in public (subtle undermining, "just checking", or "are you sure?").
          </div>
        </div>

        <div class="checklist-item" data-category="burnout" tabindex="0" role="button" aria-pressed="false">
          <i class="far fa-square"></i>
          <div class="checklist-text">
            I'm burning extra hours because control friction creates rework, delays, and anxiety loops.
          </div>
        </div>
      </div>
    </div>

    <!-- ===========================
         LEFT STEP SIDEBAR
    =========================== -->
    <div class="step-sidebar-overlay" id="stepOverlay" aria-hidden="true">
      <aside class="step-sidebar" id="stepSidebar" aria-label="Step details panel">
        <div class="step-sidebar-topbar">
          <div class="step-top-row">
            <div class="step-chip">
              <div class="step-badge" id="stepBadge">1</div>
              <div class="step-chip-text">
                <div class="step-chip-title" id="stepTitle">Step title</div>
                <div class="step-chip-sub" id="stepSubtitle">Press “Mark complete” if this is true for you.</div>
              </div>
            </div>
            <button class="step-close-btn" id="closeStepSidebar" aria-label="Close step panel">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <div class="step-sidebar-body">
          <div class="step-card">
            <div class="step-card-title"><i class="fas fa-bullseye"></i>What it signals</div>
            <p id="stepFocus"></p>
          </div>

          <div class="step-card">
            <div class="step-card-title"><i class="fas fa-lightbulb"></i>What works reliably</div>
            <ul class="step-mini-list" id="stepStrong"></ul>
          </div>

          <div class="step-card">
            <div class="step-card-title"><i class="fas fa-triangle-exclamation"></i>What not to do</div>
            <p id="stepSlip"></p>
          </div>

          <div class="step-card">
            <div class="step-card-title"><i class="fas fa-bolt"></i>Protection move</div>
            <p id="stepMicro"></p>
          </div>

          <div class="step-card">
            <div class="step-card-title"><i class="fas fa-quote-right"></i>Useful phrase</div>
            <p id="stepLine"></p>
          </div>
        </div>

        <div class="step-sidebar-footer">
          <button class="step-footer-btn secondary" id="prevStepBtn"><i class="fas fa-arrow-left"></i> Previous</button>
          <button class="step-footer-btn secondary" id="nextStepBtn">Next <i class="fas fa-arrow-right"></i></button>
          <button class="step-footer-btn primary" id="toggleStepCompleteBtn" style="grid-column: 1 / -1;">
            <i class="fas fa-check"></i> Mark complete
          </button>
        </div>
      </aside>
    </div>

    <!-- ===========================
         SCORE
    =========================== -->
    <div class="clarity-score-section">
      <div class="presence-snapshot-header">
        <h2>Your Micromanagement Snapshot</h2>
        <p>
          Your score reflects how strongly micromanagement is showing up as a system (visibility demands, decision capture, trust erosion and rework).
          A higher score doesn't automatically mean "malicious", it means the control pattern is materially affecting delivery and needs a structured response.
        </p>
      </div>

      <div class="clarity-score-bar">
        <div class="clarity-progress-container">
          <div class="clarity-header">
            <div class="clarity-title">Micromanagement Intensity Score</div>
            <div class="clarity-percentage" id="clarityPercentage">0%</div>
          </div>
          <div class="progress-container">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="progress-labels">
            <span>Low</span>
            <span>Moderate</span>
            <span>High</span>
          </div>

          <div class="presence-dimensions">
            <div class="presence-dimension-pill">
              <span class="label">Visibility Control</span>
              <span class="score" id="scoreVisibility">0%</span>
            </div>
            <div class="presence-dimension-pill">
              <span class="label">Decision Capture</span>
              <span class="score" id="scoreControl">0%</span>
            </div>
            <div class="presence-dimension-pill">
              <span class="label">Trust Erosion</span>
              <span class="score" id="scoreTrust">0%</span>
            </div>
            <div class="presence-dimension-pill">
              <span class="label">Burnout Pressure</span>
              <span class="score" id="scoreBurnout">0%</span>
            </div>
          </div>
        </div>

        <div class="actions-container">
          <button class="action-btn" onclick="generateSmartSummary()" id="generateBtn" disabled>
            <i class="fas fa-magic"></i> Generate summary
          </button>

          <!-- ✅ Phase 1 manual cloud save -->
          <button class="action-btn secondary" id="saveProgressBtn" type="button">
            <i class="fas fa-cloud-arrow-up"></i> Save progress
          </button>

          <button class="action-btn secondary" onclick="window.print()" id="printBtn">
            <i class="fas fa-print"></i> Print / Save PDF
          </button>

          <button class="action-btn secondary" id="clearBtn" type="button">
            <i class="fas fa-eraser"></i> Clear all
          </button>

          <!-- ✅ UNSAVED/LAST SAVED FEEDBACK -->
          <div class="save-progress-status" id="saveProgressStatus"></div>
        </div>
      </div>
    </div>

    <!-- ===========================
         SMART SUMMARY
    =========================== -->
    <div class="smart-summary-section" id="smartSummary">
      <div class="summary-header">
        <h2 class="summary-title">Your Smart Micromanagement Summary</h2>
        <p class="summary-subtitle">Based on your Micromanagement Intensity Score of <span id="summaryScore">0%</span></p>
        <p class="summary-insight">
          This summary identifies the manager pattern most consistent with what you selected, then gives moves that restore control without turning it into a personality war.
        </p>
      </div>

      <h3 class="section-header purple">
        <i class="fas fa-fingerprint"></i> Likely manager pattern
      </h3>

      <div class="manager-type-wrap">
        <div class="manager-type-card">
          <div class="mt-title"><i class="fas fa-user-shield"></i>Manager type</div>
          <div class="mt-name" id="managerTypeName"></div>
          <div class="mt-desc" id="managerTypeDesc"></div>
        </div>

        <div class="manager-handling-card">
          <div class="mt-title"><i class="fas fa-chess"></i>How to deal with it</div>
          <ul class="mt-list" id="managerTypeMoves"></ul>
        </div>
      </div>

      <h3 class="section-header red">
        <i class="fas fa-exclamation-triangle"></i> Risk flags in your situation
      </h3>
      <div class="red-flags-grid" id="redFlagsGrid"></div>

      <h3 class="section-header purple">
        <i class="fas fa-forward"></i> What to do next
      </h3>
      <div class="next-steps-grid" id="nextStepsGrid"></div>

      <h3 class="section-header blue">
        <i class="fas fa-tools"></i> Recommended tools to support you
      </h3>
      <div class="resources-grid" id="resourcesGrid"></div>
    </div>

    <!-- ===========================
         CLOSURE
    =========================== -->
    <div class="closure-section" id="closureSection">
      <div class="closure-card">
        <div class="closure-left">
          <div class="closure-title">
            <i class="fas fa-flag-checkered"></i>
            <h3>Closure: lock your next 7 days</h3>
          </div>

          <p class="closure-lead">
            Your goal now is simple: reduce control friction while increasing confidence signals.
            Do it with a clean operating rhythm, crisp decision records, and predictable checkpoints, not confrontation.
          </p>

          <ul class="closure-list" id="closureList"></ul>
        </div>

        <aside class="closure-right">
          <div class="tip-card">
            <div class="tip-head">
              <i class="fas fa-lightbulb"></i>
              <span>PRACTICAL TIP</span>
            </div>
            <p class="tip-body" id="closureTip"></p>
          </div>
        </aside>
      </div>
    </div>

    <!-- ===========================
         MY PLAYBOOK SIDEBAR (Right)
    =========================== -->
    <div class="playbook-sidebar-overlay" id="playbookOverlay">
      <div class="playbook-sidebar" id="playbookSidebar">
        <div class="playbook-sidebar-header">
          <div class="playbook-sidebar-header-title-row">
            <h3>My Playbook</h3>
            <button class="playbook-close-btn" id="closePlaybook" aria-label="Close My Playbook" type="button">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <p>Saved items</p>
        </div>

        <div class="playbook-sidebar-body">
          <div id="savedItemsContainer">
            <p class="saved-items-empty" id="savedItemsEmpty">
              You haven't saved anything yet. Use <strong>Save item</strong> on tools you want quick access to.
            </p>
            <ul class="saved-items-list" id="savedItemsList"></ul>
          </div>

          <div class="playbook-quick-links">
            <div class="playbook-quick-links-header">
              <span class="quick-links-title">Quick links</span>
            </div>
            <div class="playbook-quick-links-list">
              <a href="dashboard.html" class="quick-link-pill">
                <i class="fas fa-gauge"></i> The Dashboard
              </a>
              <a href="the-lens.html" class="quick-link-pill">
                <i class="fas fa-search"></i> The Lens
              </a>
              <a href="the-toolkit.html" class="quick-link-pill">
                <i class="fas fa-toolbox"></i> The Toolkit
              </a>
              <a href="the-coach.html" class="quick-link-pill">
                <i class="fas fa-comments"></i> The Coach
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating My Playbook button -->
    <div class="my-playbook-fab" id="myPlaybookButton" role="button" tabindex="0" aria-label="Open My Playbook">
      <i class="fas fa-book-open"></i>
      <span>My Playbook</span>
    </div>

    <!-- ===========================
         FOOTER
    =========================== -->
    <footer>
      <div class="container">
        <p>© 2025 The Employee Playbook. All rights reserved.</p>
      </div>
    </footer>
  </main>

  <!-- ===========================
       AUTH LOCK OVERLAY
  =========================== -->
  <div class="auth-lock-overlay" id="authLockOverlay" aria-hidden="true">
    <div class="auth-lock-card" role="dialog" aria-modal="true" aria-label="Sign in required">
      <div class="auth-lock-title">
        <i class="fas fa-lock"></i>
        Sign in required
      </div>
      <div class="auth-lock-text">
        This tool is available to signed-in members so your progress can be saved securely.
        Sign in to unlock the checklist and report.
      </div>
      <div class="auth-lock-actions">
        <a class="auth-lock-btn primary" href="./sign-in.html">
          <i class="fas fa-right-to-bracket"></i> Sign in
        </a>
        <a class="auth-lock-btn secondary" href="the-pricing.html">
          <i class="fas fa-gem"></i> View plans
        </a>
      </div>
    </div>
  </div>

  <!-- ===========================
       JAVASCRIPT (page logic)
  =========================== -->
  <script>
    /* =========================================================
       TOOL ID + VERSION (tool_states)
    ========================================================= */
    const TOOL_ID = "micromanagement-framework";
    const TOOL_VERSION = 1;

    /* =========================================================
       PHASE 1: UNSAVED / LAST SAVED UI
    ========================================================= */
    window.__tep_unsaved = false;

    function fmtGB(ts) {
      try {
        return new Date(ts).toLocaleString('en-GB', {
          day: '2-digit', month: 'short', year: 'numeric',
          hour: '2-digit', minute: '2-digit'
        });
      } catch (e) { return ''; }
    }

    function setSaveStatus(text, type = "info") {
      const el = document.getElementById("saveProgressStatus");
      if (!el) return;
      el.textContent = text || "";
      el.style.color =
        type === "ok" ? "var(--success-green)" :
        type === "err" ? "var(--danger-red)" :
        "var(--dark-gray)";
    }

    function markUnsaved() {
      window.__tep_unsaved = true;
      const last = localStorage.getItem("tep_last_saved_" + TOOL_ID);
      const suffix = last ? ` • Last saved: ${fmtGB(last)}` : "";
      setSaveStatus("Unsaved changes" + suffix, "info");
    }

    function markSaved(nowIso) {
      window.__tep_unsaved = false;
      const stamp = nowIso || new Date().toISOString();
      localStorage.setItem("tep_last_saved_" + TOOL_ID, stamp);
      setSaveStatus(`Saved • ${fmtGB(stamp)}`, "ok");
    }

    function markLoaded() {
      window.__tep_unsaved = false;
      const last = localStorage.getItem("tep_last_saved_" + TOOL_ID);
      const suffix = last ? ` • Last saved: ${fmtGB(last)}` : "";
      setSaveStatus("Loaded your saved progress" + suffix, "ok");
    }

    function markNeutral() {
      const last = localStorage.getItem("tep_last_saved_" + TOOL_ID);
      if (last) setSaveStatus(`Last saved: ${fmtGB(last)}`, "info");
      else setSaveStatus("", "info");
    }

    /* =========================================================
       DOM READY
    ========================================================= */
    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add('loaded');

      // Apply preload theme properly to body
      try {
        const saved = localStorage.getItem('theme');
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const useDark = saved ? saved === 'dark' : prefersDark;
        if (useDark) document.body.classList.add('dark-mode');
        document.documentElement.classList.remove('preload-dark');
      } catch (e) {}

      initializeChecklist();
      initializeThemeToggle();
      initializeMobileNav();
      initializePlaybook();
      wireHeaderMyPlaybookHooks();
      wireFabKeyboard();
      initializeStepSidebar();

      // Wire save/clear
      document.getElementById("saveProgressBtn")?.addEventListener("click", () => saveProgressToCloud());
      document.getElementById("clearBtn")?.addEventListener("click", () => clearAll());

      // Auth + lock + restore
      initSupabaseAuthAndLock();

      // Default status
      markNeutral();
    });

    /* =========================================================
       MOBILE NAV (with aria-expanded)
    ========================================================= */
    function initializeMobileNav() {
      const mobileToggle = document.querySelector('.mobile-toggle');
      const navLinks = document.querySelector('.nav-links');

      if (mobileToggle && navLinks) {
        mobileToggle.addEventListener('click', function () {
          const isOpen = navLinks.classList.toggle('active');
          this.setAttribute("aria-expanded", isOpen ? "true" : "false");

          const icon = this.querySelector('i');
          if (icon) {
            icon.classList.toggle('fa-bars');
            icon.classList.toggle('fa-times');
          }
        });
      }

      document.addEventListener('click', function(event) {
        if (!navLinks || !mobileToggle) return;
        if (navLinks.classList.contains('active') &&
            !navLinks.contains(event.target) &&
            !mobileToggle.contains(event.target)) {
          navLinks.classList.remove('active');
          mobileToggle.setAttribute("aria-expanded", "false");
          const icon = mobileToggle.querySelector('i');
          if (icon) {
            icon.classList.add('fa-bars');
            icon.classList.remove('fa-times');
          }
        }
      });
    }

    /* =========================================================
       THEME TOGGLE (stable)
    ========================================================= */
    function initializeThemeToggle() {
      const themeToggleBtn = document.getElementById('themeToggleBtn');
      if (!themeToggleBtn) return;

      const themeIcon = themeToggleBtn.querySelector('i');
      const logoImg = document.getElementById('mainLogo');

      function updateIcon(isDark) {
        if (!themeIcon) return;
        themeIcon.classList.toggle('fa-moon', !isDark);
        themeIcon.classList.toggle('fa-sun', isDark);
      }

      function updateLogo(isDark) {
        if (!logoImg) return;
        logoImg.src = isDark ? 'assets/img/logo-dark.png' : 'assets/img/logo.png';
      }

      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isDarkInitial = saved ? saved === 'dark' : prefersDark;
      updateIcon(isDarkInitial);
      updateLogo(isDarkInitial);

      themeToggleBtn.addEventListener('click', function() {
        const isDarkMode = document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        updateIcon(isDarkMode);
        updateLogo(isDarkMode);
      });

      const mq = window.matchMedia('(prefers-color-scheme: dark)');
      mq.addEventListener('change', (e) => {
        if (localStorage.getItem('theme')) return;
        const shouldDark = e.matches;
        document.body.classList.toggle('dark-mode', shouldDark);
        updateIcon(shouldDark);
        updateLogo(shouldDark);
      });

      if (logoImg) {
        logoImg.addEventListener('error', function() {
          if (this.src.includes('logo-dark.png')) {
            this.src = 'assets/img/logo.png';
          } else {
            this.style.display = 'none';
            const fb = document.getElementById('logo-fallback');
            if (fb) fb.style.display = 'block';
          }
        });
      }
    }

    /* =========================================================
       CHECKLIST LOGIC (state on window)
    ========================================================= */
    window.checkedItems = [];
    window.itemCategories = [];

    const dimensionConfig = {
      visibility: ['visibility', 'process'],
      control: ['control'],
      trust: ['trust', 'tone', 'politics', 'hr'],
      burnout: ['burnout']
    };

    function getCheckedCount() {
      return Array.isArray(window.checkedItems) ? window.checkedItems.filter(Boolean).length : 0;
    }
    window.getCheckedCount = getCheckedCount;

    function initializeChecklist() {
      const checklistContainers = document.querySelectorAll('.checklist-item');
      window.checkedItems = new Array(checklistContainers.length).fill(false);
      window.itemCategories = [];

      checklistContainers.forEach((container, index) => {
        const icon = container.querySelector('i');
        const category = container.getAttribute('data-category');
        window.itemCategories[index] = category;

        const toggleItem = () => {
          if (!icon) return;

          if (icon.classList.contains('fa-square')) {
            icon.classList.remove('fa-square');
            icon.classList.add('fa-check-square');
            icon.style.color = '#5A4496';
            window.checkedItems[index] = true;
            container.setAttribute("aria-pressed", "true");
          } else {
            icon.classList.remove('fa-check-square');
            icon.classList.add('fa-square');
            icon.style.color = '#7B5FC4';
            window.checkedItems[index] = false;
            container.setAttribute("aria-pressed", "false");
          }

          updatePresenceScore();
          markUnsaved();
        };

        // Click = open details panel (not toggle) so it behaves like a "framework step"
        container.addEventListener('click', function(e) {
          if (document.body.classList.contains("auth-locked")) return;
          openStepSidebar(index);
        });

        // Keyboard: Enter opens details, Space toggles (accessibility + speed)
        container.addEventListener("keydown", (e) => {
          if (document.body.classList.contains("auth-locked")) return;

          if (e.key === "Enter") {
            e.preventDefault();
            openStepSidebar(index);
          }
          if (e.key === " ") {
            e.preventDefault();
            toggleItem();
          }
        });

        // Toggle directly if user clicks the square icon
        icon?.addEventListener("click", (e) => {
          e.stopPropagation();
          if (document.body.classList.contains("auth-locked")) return;
          toggleItem();
        });
      });

      updatePresenceScore();
    }

    function syncActionButtons(isLocked) {
      const generateBtn = document.getElementById('generateBtn');
      const copyBtn = document.getElementById('copyBtn');
      const printBtn = document.getElementById('printBtn');
      const saveProgressBtn = document.getElementById('saveProgressBtn');
      const clearBtn = document.getElementById('clearBtn');

      const checkedCount = getCheckedCount();

      if (generateBtn) generateBtn.disabled = !!isLocked || checkedCount === 0;
      if (copyBtn) copyBtn.disabled = !!isLocked;
      if (printBtn) printBtn.disabled = !!isLocked;
      if (saveProgressBtn) saveProgressBtn.disabled = !!isLocked;
      if (clearBtn) clearBtn.disabled = !!isLocked;
    }
    window.syncActionButtons = syncActionButtons;

    function updatePresenceScore() {
      const checkedCount = getCheckedCount();
      const totalCount = window.checkedItems.length;
      const score = totalCount > 0 ? Math.round((checkedCount / totalCount) * 100) : 0;

      document.getElementById('clarityPercentage').textContent = score + '%';
      const progressFill = document.getElementById('progressFill');
      progressFill.style.width = score + '%';

      progressFill.classList.remove('high', 'medium', 'low');
      if (score >= 75) progressFill.classList.add('high');
      else if (score >= 40) progressFill.classList.add('medium');
      else progressFill.classList.add('low');

      const locked = document.body.classList.contains("auth-locked");
      syncActionButtons(locked);

      const dimensionScores = {
        visibility: { checked: 0, total: 0 },
        control: { checked: 0, total: 0 },
        trust: { checked: 0, total: 0 },
        burnout: { checked: 0, total: 0 }
      };

      window.itemCategories.forEach((category, index) => {
        Object.keys(dimensionConfig).forEach(dim => {
          if (dimensionConfig[dim].includes(category)) {
            dimensionScores[dim].total += 1;
            if (window.checkedItems[index]) dimensionScores[dim].checked += 1;
          }
        });
      });

      const visibilityScore = dimensionScores.visibility.total ? Math.round((dimensionScores.visibility.checked / dimensionScores.visibility.total) * 100) : 0;
      const controlScore = dimensionScores.control.total ? Math.round((dimensionScores.control.checked / dimensionScores.control.total) * 100) : 0;
      const trustScore = dimensionScores.trust.total ? Math.round((dimensionScores.trust.checked / dimensionScores.trust.total) * 100) : 0;
      const burnoutScore = dimensionScores.burnout.total ? Math.round((dimensionScores.burnout.checked / dimensionScores.burnout.total) * 100) : 0;

      document.getElementById('scoreVisibility').textContent = visibilityScore + '%';
      document.getElementById('scoreControl').textContent = controlScore + '%';
      document.getElementById('scoreTrust').textContent = trustScore + '%';
      document.getElementById('scoreBurnout').textContent = burnoutScore + '%';

      if (typeof refreshStepCompleteButton === 'function') refreshStepCompleteButton();
    }

    window.updatePresenceScore = updatePresenceScore;

    /* =========================================================
       LEFT STEP SIDEBAR CONTENT
    ========================================================= */
    const stepData = [
      {
        title: "Visibility demands",
        focus: "This usually signals anxiety about unknowns: they want proof, not progress.",
        strong: ["Offer predictable checkpoints (not constant pings).", "Send 'headline + risk + next' updates.", "Anchor updates to outcomes and dates."],
        slip: "Over-explaining or replying instantly trains more surveillance.",
        micro: "Propose one checkpoint rhythm: 'Daily 10-min / Tue+Thu / end-of-day only'. Put it in writing.",
        line: "'To keep momentum high, I'll send a short update at 4pm with status, risks, and next steps.'"
      },
      {
        title: "Rewriting your work",
        focus: "This is control capture. It can be insecurity, perfectionism, or reputation protection.",
        strong: ["Give options (A/B) with a recommendation.", "Ask for criteria: what 'good' looks like.", "Lock 'definition of done' early."],
        slip: "Arguing about ego or taking it personally, it escalates and changes nothing.",
        micro: "Ask for a style/decision standard once, then apply it consistently.",
        line: "'What are the 3 criteria you want this to meet? I'll align to those and keep future drafts consistent.'"
      },
      {
        title: "Decision pull-back",
        focus: "This signals low trust, or they need to be seen as the final gatekeeper.",
        strong: ["Create a decision record: what was agreed, by whom, and why.", "Use 'If no objections by X' to close loops.", "Keep stakeholders aligned without bypassing."],
        slip: "Publicly contradicting them or forcing a power contest in the meeting.",
        micro: "Send a post-meeting decision note with a clean summary and next action owners.",
        line: "'To keep us aligned, I'll capture the decision in writing and proceed unless we flag changes by tomorrow 11am.'"
      },
      {
        title: "Approval for routine actions",
        focus: "This is process as control, often framed as 'risk management'.",
        strong: ["Offer a risk threshold: what needs approval vs what doesn't.", "Pre-approve a scope of autonomy.", "Use checklists to reduce their anxiety."],
        slip: "Quietly ignoring the process, it gives them a formal reason to clamp down.",
        micro: "Propose an autonomy band: 'I'll run X without approval; I'll bring Y for sign-off.'",
        line: "'Can we agree a threshold: I'll proceed within X, and I'll bring anything above Y for approval.'"
      },
      {
        title: "Tone policing",
        focus: "This is often a power lever: controlling how you sound keeps you small and pliable.",
        strong: ["Shift to outcomes and stakeholder impact.", "Use neutral language and written records.", "Ask for examples, not opinions."],
        slip: "Debating 'tone' emotionally, it becomes subjective and endless.",
        micro: "Ask for one concrete rewrite example, then standardise your template.",
        line: "'Can you show me one example sentence you'd change and why, so I can apply the same standard consistently?'"
      },
      {
        title: "Unplanned status checks",
        focus: "This is intolerance of uncertainty. The fix is predictability, not reassurance.",
        strong: ["Pre-empt with a short, scheduled update.", "Use one-line 'still on track' messages.", "Separate progress from problem escalation."],
        slip: "Apologising for being busy, it invites more intrusion.",
        micro: "Introduce a shared tracker or weekly plan with dates and owners.",
        line: "'Still on track. Next visible milestone is Thursday. I'll flag early if risk changes.'"
      },
      {
        title: "They present your work",
        focus: "This can be credit capture or control of narrative. Both erode your authority over time.",
        strong: ["Ask to present one section.", "Send your own pre-read note to stakeholders.", "Get your name attached to outputs."],
        slip: "Calling it out as 'stealing credit', it triggers defence and politics.",
        micro: "Request a defined slot: 'I'll walk the team through X; you cover Y.'",
        line: "'Happy for you to open, I'll take the walkthrough of the analysis and recommendations.'"
      },
      {
        title: "Optics management",
        focus: "This suggests politics: control is used to manage reputation and power.",
        strong: ["Keep decisions documented.", "Avoid private side debates; pull issues into structured forums.", "Build stakeholder alignment calmly."],
        slip: "Sharing frustrations widely, it can be used against you.",
        micro: "Maintain a private record: dates, decisions, reversals, impact.",
        line: "'For clarity, I'll capture the agreed position in a short note so we keep the external message consistent.'"
      },
      {
        title: "No definition of done",
        focus: "Endless iteration is a control loop. The exit is criteria plus sign-off moments.",
        strong: ["Agree success criteria upfront.", "Add sign-off checkpoints.", "Timebox revisions."],
        slip: "Continuing to 'polish' indefinitely, you teach them it's acceptable.",
        micro: "Timebox: 'Two revisions, then final.' Put it in writing.",
        line: "'I'll incorporate this round, then I suggest we lock it after one final review tomorrow.'"
      },
      {
        title: "Policy used as control",
        focus: "This can drift into formal pressure. Treat it seriously and protect yourself early.",
        strong: ["Stay compliant in writing.", "Ask for the specific standard, not vague references.", "Escalate only with evidence and calm."],
        slip: "Being dismissive, it hands them 'process' as a weapon.",
        micro: "Ask for the exact requirement and align your workflow to it.",
        line: "'Which specific policy/standard are we aligning to? I'll map the work to it so it's clear.'"
      },
      {
        title: "Public undermining",
        focus: "This is credibility damage. It needs boundaries, not more competence proof.",
        strong: ["Respond to content, not tone.", "Offer a written follow-up with facts.", "Request a private alignment meeting."],
        slip: "Defending yourself in the room, it looks reactive and feeds the dynamic.",
        micro: "After the meeting: 'I'd like to align on how we handle questions live so we keep confidence high.'",
        line: "'Good question, I'll confirm the detail and send a short note so we're all aligned.'"
      },
      {
        title: "Burnout via rework",
        focus: "This means control friction is now a productivity risk and a health risk.",
        strong: ["Reduce rework with criteria.", "Add checkpoints and close loops.", "Protect focus blocks and delivery windows."],
        slip: "Quietly absorbing the damage, it becomes 'normal' and then permanent.",
        micro: "Name impact neutrally: time lost to rework; propose a new operating rhythm.",
        line: "'To protect delivery dates, can we agree checkpoints and criteria so we reduce rework cycles?'"
      }
    ];

    let currentStepIndex = null;

    function initializeStepSidebar() {
      const overlay = document.getElementById('stepOverlay');
      const sidebar = document.getElementById('stepSidebar');
      const closeBtn = document.getElementById('closeStepSidebar');
      const prevBtn = document.getElementById('prevStepBtn');
      const nextBtn = document.getElementById('nextStepBtn');
      const toggleCompleteBtn = document.getElementById('toggleStepCompleteBtn');

      if (!overlay || !sidebar || !closeBtn || !prevBtn || !nextBtn || !toggleCompleteBtn) return;

      closeBtn.addEventListener('click', closeStepSidebar);

      overlay.addEventListener('click', (e) => {
        if (e.target === overlay) closeStepSidebar();
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeStepSidebar();
      });

      prevBtn.addEventListener('click', () => {
        if (currentStepIndex === null) return;
        openStepSidebar(Math.max(0, currentStepIndex - 1));
      });

      nextBtn.addEventListener('click', () => {
        if (currentStepIndex === null) return;
        openStepSidebar(Math.min(stepData.length - 1, currentStepIndex + 1));
      });

      toggleCompleteBtn.addEventListener('click', () => {
        if (currentStepIndex === null) return;
        toggleChecklistItemByIndex(currentStepIndex);
        refreshStepCompleteButton();
        markUnsaved();
      });
    }

    function openStepSidebar(index) {
      const overlay = document.getElementById('stepOverlay');
      const sidebar = document.getElementById('stepSidebar');
      if (!overlay || !sidebar) return;

      currentStepIndex = index;

      const data = stepData[index] || {};
      document.getElementById('stepBadge').textContent = (index + 1);
      document.getElementById('stepTitle').textContent = data.title || 'Step';
      document.getElementById('stepFocus').textContent = data.focus || '';

      const strongList = document.getElementById('stepStrong');
      strongList.innerHTML = '';
      (data.strong || []).forEach(item => {
        const li = document.createElement('li');
        li.textContent = item;
        strongList.appendChild(li);
      });

      document.getElementById('stepSlip').textContent = data.slip || '';
      document.getElementById('stepMicro').textContent = data.micro || '';
      document.getElementById('stepLine').textContent = data.line || '';

      document.getElementById('prevStepBtn').disabled = index === 0;
      document.getElementById('nextStepBtn').disabled = index === (stepData.length - 1);

      refreshStepCompleteButton();

      overlay.classList.add('open');
      sidebar.classList.add('open');
      overlay.setAttribute('aria-hidden', 'false');
    }

    function closeStepSidebar() {
      const overlay = document.getElementById('stepOverlay');
      const sidebar = document.getElementById('stepSidebar');
      if (!overlay || !sidebar) return;

      overlay.classList.remove('open');
      sidebar.classList.remove('open');
      overlay.setAttribute('aria-hidden', 'true');
    }

    function toggleChecklistItemByIndex(index) {
      const items = document.querySelectorAll('.checklist-item');
      const target = items[index];
      if (!target) return;

      const icon = target.querySelector('i');
      if (!icon) return;

      if (icon.classList.contains('fa-square')) {
        icon.classList.remove('fa-square');
        icon.classList.add('fa-check-square');
        icon.style.color = '#5A4496';
        window.checkedItems[index] = true;
        target.setAttribute("aria-pressed", "true");
      } else {
        icon.classList.remove('fa-check-square');
        icon.classList.add('fa-square');
        icon.style.color = '#7B5FC4';
        window.checkedItems[index] = false;
        target.setAttribute("aria-pressed", "false");
      }

      updatePresenceScore();
    }

    function refreshStepCompleteButton() {
      const btn = document.getElementById('toggleStepCompleteBtn');
      if (!btn || currentStepIndex === null) return;

      const isComplete = !!window.checkedItems[currentStepIndex];
      btn.innerHTML = isComplete
        ? '<i class="fas fa-rotate-left"></i> Mark as not true'
        : '<i class="fas fa-check"></i> Mark complete';
    }

    /* =========================================================
       SMART SUMMARY (+ MANAGER TYPE + CLOSURE)
    ========================================================= */
    function generateSmartSummary() {
      const checkedCount = getCheckedCount();
      const totalCount = window.checkedItems.length;
      const score = totalCount > 0 ? Math.round((checkedCount / totalCount) * 100) : 0;

      document.getElementById('summaryScore').textContent = score + '%';

      const summarySection = document.getElementById('smartSummary');
      summarySection.classList.add('active');
      summarySection.scrollIntoView({ behavior: 'smooth' });

      const pattern = inferManagerPattern();
      renderManagerType(pattern);

      generateRiskFlags();
      generateNextMoves(score, pattern);
      generateRecommendedResources(pattern);

      renderClosure(pattern);
    }

    function countByCategory() {
      const counts = {};
      window.checkedItems.forEach((checked, idx) => {
        if (!checked) return;
        const cat = window.itemCategories[idx];
        counts[cat] = (counts[cat] || 0) + 1;
      });
      return counts;
    }

    function inferManagerPattern() {
      const c = countByCategory();

      const scores = {
        "Anxious Checker": (c.visibility || 0) + (c.process || 0),
        "Control Capturer": (c.control || 0) + (c.process || 0),
        "Insecure Gatekeeper": (c.trust || 0) + (c.tone || 0),
        "Political Controller": (c.politics || 0) + (c.trust || 0),
        "Process Enforcer": (c.hr || 0) + (c.process || 0)
      };

      let topName = "Mixed Pattern";
      let topScore = 0;

      Object.keys(scores).forEach(name => {
        if (scores[name] > topScore) {
          topScore = scores[name];
          topName = name;
        }
      });

      if (topScore === 0) topName = "Low Signal / Early Stage";

      const library = {
        "Anxious Checker": {
          desc: "They struggle with unknowns. Control shows up as frequent check-ins and demand for visibility, even when nothing has changed.",
          moves: [
            "Replace ad-hoc pings with a predictable update rhythm (short, scheduled, outcome-based).",
            "Use 'headline + risk + next' updates, no long narratives.",
            "Pre-agree what triggers escalation versus what doesn't."
          ],
          tip: "Consistency beats reassurance. If your rhythm is stable, their anxiety has less space to grow."
        },
        "Control Capturer": {
          desc: "They want final ownership: rewrites, approvals, and decision pull-backs. Delivery becomes slower because control friction keeps expanding.",
          moves: [
            "Ask for criteria and definition of done, in writing.",
            "Offer options with recommendations (it gives them 'control' without takeover).",
            "Close decisions using written decision records and timeboxed review windows."
          ],

          tip: "Don't debate autonomy. Trade it for delivery controls: criteria, timeboxes, and written decisions."
        },
        "Insecure Gatekeeper": {
          desc: "They need to be the final voice. You’ll see public second-guessing, tone policing, and decision pull-backs to keep status control.",
          moves: [
            "Shift to written clarity: decision records, acceptance criteria, and stakeholder-visible summaries.",
            "Ask for examples and standards (not opinions) so you can align once and repeat.",
            "Handle challenges calmly: answer the question, then follow up in writing with facts."
          ],
          tip: "Stop trying to earn trust through more effort. Earn it through predictable clarity and clean evidence."
        },
        "Political Controller": {
          desc: "They manage optics and access. Control is used to shape reputation, credit, and who’s ‘in’ or ‘out’.",
          moves: [
            "Document decisions and reversals privately (dates, impact, who changed what).",
            "Avoid emotional side chats; bring alignment into structured forums and notes.",
            "Attach your name to outputs and pre-reads so your work has a public trail."
          ],
          tip: "In politics-heavy environments, your shield is documentation + calm consistency."
        },
        "Process Enforcer": {
          desc: "They use policy language as a control lever. It may start as ‘standards’ and drift into formal pressure if unchecked.",
          moves: [
            "Ask for the specific requirement (exact policy/standard), then map your workflow to it.",
            "Stay compliant in writing and keep your audit trail tidy.",
            "Escalate only with evidence and a neutral tone if it becomes punitive."
          ],
          tip: "Treat ‘process’ seriously. The moment it goes formal, you want your evidence clean."
        },
        "Mixed Pattern": {
          desc: "Your selections span multiple types. That usually means the manager changes behaviour under stress or in different audiences.",
          moves: [
            "Stabilise the basics: checkpoints, criteria, and decision records.",
            "Run a weekly plan with milestones and owners so visibility is baked in.",
            "Identify the 1–2 behaviours doing the most damage and tackle those first."
          ],
          tip: "You don’t need a perfect diagnosis. You need a rhythm that reduces friction."
        },
        "Low Signal / Early Stage": {
          desc: "Right now the pattern is light or inconsistent. Act early before it becomes the default operating system.",
          moves: [
            "Set a simple checkpoint rhythm and stick to it.",
            "Agree what needs approval vs what doesn’t (thresholds).",
            "Capture decisions in short notes so scope creep doesn’t restart everything."
          ],
          tip: "Early moves are easiest. Don’t wait for it to become ‘normal’."
        }
      };

      return library[topName] ? { name: topName, ...library[topName] } : { name: topName, ...library["Mixed Pattern"] };
    }

    function renderManagerType(pattern) {
      const nameEl = document.getElementById("managerTypeName");
      const descEl = document.getElementById("managerTypeDesc");
      const movesEl = document.getElementById("managerTypeMoves");

      if (nameEl) nameEl.textContent = pattern?.name || "";
      if (descEl) descEl.textContent = pattern?.desc || "";
      if (movesEl) {
        movesEl.innerHTML = "";
        (pattern?.moves || []).forEach(m => {
          const li = document.createElement("li");
          li.textContent = m;
          movesEl.appendChild(li);
        });
      }
    }

    function generateRiskFlags() {
      const grid = document.getElementById("redFlagsGrid");
      if (!grid) return;

      const checkedCount = getCheckedCount();
      const totalCount = window.checkedItems.length;
      const score = totalCount > 0 ? Math.round((checkedCount / totalCount) * 100) : 0;

      const flags = [];

      if (score >= 75) {
        flags.push({
          title: "Delivery risk is now real",
          desc: "Control friction is consuming time and slowing outcomes. This can become your ‘performance story’ unless you reset the rhythm."
        });
      }

      const counts = countByCategory();
      if ((counts.trust || 0) >= 2) {
        flags.push({
          title: "Credibility erosion risk",
          desc: "Repeated public questioning or decision pull-backs can change how others see your judgement — even if your work is solid."
        });
      }

      if ((counts.burnout || 0) >= 1) {
        flags.push({
          title: "Burnout pressure rising",
          desc: "Rework + anxiety loops can drive extra hours and lower clarity. Protect focus blocks and reduce rework cycles fast."
        });
      }

      if ((counts.hr || 0) >= 1) {
        flags.push({
          title: "Process-as-weapon potential",
          desc: "If policy language is being used to control rather than coach, keep your written trail clean and avoid informal ambiguity."
        });
      }

      if (flags.length === 0) {
        flags.push({
          title: "Early stage — act now",
          desc: "This looks containable. Small structure changes now prevent bigger control patterns later."
        });
      }

      grid.innerHTML = "";
      flags.slice(0, 6).forEach(f => {
        const card = document.createElement("div");
        card.className = "red-flag-card";
        card.innerHTML = `
          <div class="flag-icon"><i class="fas fa-flag"></i></div>
          <div class="flag-title">${escapeHtml(f.title)}</div>
          <div class="flag-description">${escapeHtml(f.desc)}</div>
        `;
        grid.appendChild(card);
      });
    }

    function generateNextMoves(score, pattern) {
      const grid = document.getElementById("nextStepsGrid");
      if (!grid) return;

      const steps = [];

      // Universal foundations
      steps.push({
        title: "Install a checkpoint rhythm",
        desc: "Replace ad-hoc pings with a predictable cadence (e.g., Tue/Thu + end-of-day). Updates: headline, risk, next."
      });

      steps.push({
        title: "Create a decision record",
        desc: "After key meetings, send a short note: what’s agreed, why, who owns what, and the ‘change-by’ deadline."
      });

      // Score-based
      if (score >= 75) {
        steps.push({
          title: "Timebox revisions",
          desc: "Agree a definition of done + ‘two revisions then final’. Endless iteration is a control loop — you need an exit."
        });
        steps.push({
          title: "Protection mode (quietly)",
          desc: "Keep a private log of reversals, rework, and public undermining. If it escalates, you’ll need evidence not emotion."
        });
      } else if (score >= 40) {
        steps.push({
          title: "Agree autonomy thresholds",
          desc: "Define what you can run without approval vs what needs sign-off. Control drops when risk boundaries are clear."
        });
      } else {
        steps.push({
          title: "Set expectations early",
          desc: "Propose how you’ll run work: milestones, check-ins, and how you’ll flag risk. Don’t wait for drift."
        });
      }

      // Pattern lens
      if (pattern?.name === "Political Controller") {
        steps.push({
          title: "Attach your name to outputs",
          desc: "Use pre-reads and visible notes so your work has a public trail. It reduces credit capture and narrative control."
        });
      }

      grid.innerHTML = "";
      steps.slice(0, 6).forEach(s => {
        const card = document.createElement("div");
        card.className = "next-step-card";
        card.innerHTML = `
          <div class="step-icon"><i class="fas fa-forward"></i></div>
          <div class="step-title">${escapeHtml(s.title)}</div>
          <div class="step-description">${escapeHtml(s.desc)}</div>
        `;
        grid.appendChild(card);
      });
    }

    function generateRecommendedResources(pattern) {
      const grid = document.getElementById("resourcesGrid");
      if (!grid) return;

      const resources = [
        { title: "Decision Clarity Checklist", desc: "Lock decisions, prevent reopen loops, and keep scope stable.", href: "decision-clarity-checklist.html" },
        { title: "Boundary Strength Checklist", desc: "Set calm boundaries that protect focus and reduce intrusion.", href: "boundary-strength-checklist.html" },
        { title: "Workload Clarity Checklist", desc: "Make capacity visible and reduce rework by aligning priorities.", href: "workload-clarity-checklist.html" }
      ];

      if (pattern?.name === "Political Controller") {
        resources.unshift({ title: "Stakeholder Mapping Grid", desc: "Map influence + alignment so optics don’t ambush you.", href: "stakeholder-mapping-grid.html" });
      }

      grid.innerHTML = "";
      resources.slice(0, 6).forEach(r => {
        const card = document.createElement("div");
        card.className = "resource-card";
        card.innerHTML = `
          <div class="resource-icon"><i class="fas fa-tools"></i></div>
          <div class="resource-title">${escapeHtml(r.title)}</div>
          <div class="resource-description">${escapeHtml(r.desc)}</div>
          <a class="resource-link" href="${r.href}"><span>Open tool</span> <i class="fas fa-arrow-right"></i></a>
        `;
        grid.appendChild(card);
      });
    }

    function renderClosure(pattern) {
      const section = document.getElementById("closureSection");
      const list = document.getElementById("closureList");
      const tip = document.getElementById("closureTip");
      if (!section || !list || !tip) return;

      const items = [
        "Pick one checkpoint rhythm and stick to it (don’t negotiate daily).",
        "Send 2 decision records this week for anything that could be reopened.",
        "Ask once for criteria/definition of done on the highest-visibility deliverable.",
        "Protect 2 focus blocks (no updates inside them unless risk changes).",
        "Keep a private ‘rework + reversals’ log if the behaviour is escalating."
      ];

      list.innerHTML = "";
      items.forEach(t => {
        const li = document.createElement("li");
        li.innerHTML = `<span class="dot"></span><span>${escapeHtml(t)}</span>`;
        list.appendChild(li);
      });

      tip.textContent = pattern?.tip || "Structure beats emotion. Make the operating system predictable and the control pressure drops.";

      section.classList.add("active");
    }

    /* =========================================================
       COPY + CLEAR
    ========================================================= */
    function copyChecklist() {
      const items = Array.from(document.querySelectorAll(".checklist-item .checklist-text")).map((el, idx) => {
        const checked = !!window.checkedItems[idx];
        return `${checked ? "[x]" : "[ ]"} ${el.textContent.trim()}`;
      });

      const text = `Micromanagement Signals Checklist\n\n${items.join("\n")}`;

      navigator.clipboard?.writeText(text).then(() => {
        setSaveStatus("Copied checklist to clipboard", "ok");
        setTimeout(markNeutral, 1600);
      }).catch(() => {
        setSaveStatus("Copy failed — please try again", "err");
      });
    }

    function clearAll() {
      // reset checks
      const nodes = document.querySelectorAll(".checklist-item");
      nodes.forEach((node, idx) => {
        const icon = node.querySelector("i");
        if (!icon) return;
        icon.classList.remove("fa-check-square");
        icon.classList.add("fa-square");
        icon.style.color = "#7B5FC4";
        window.checkedItems[idx] = false;
        node.setAttribute("aria-pressed", "false");
      });

      // hide summary/closure
      document.getElementById("smartSummary")?.classList.remove("active");
      document.getElementById("closureSection")?.classList.remove("active");

      closeStepSidebar();
      updatePresenceScore();
      markUnsaved();
      setSaveStatus("Cleared", "ok");
      setTimeout(markNeutral, 1200);

      // optional: clear local fallback state
      localStorage.removeItem("tep_local_state_" + TOOL_ID);
    }

    /* =========================================================
       MY PLAYBOOK (Save item) — localStorage
    ========================================================= */
    function getSavedItems() {
      try {
        return JSON.parse(localStorage.getItem("tep_saved_items") || "[]");
      } catch (e) {
        return [];
      }
    }

    function setSavedItems(items) {
      localStorage.setItem("tep_saved_items", JSON.stringify(items || []));
    }

    function isItemSaved(toolId) {
      return getSavedItems().some(x => x && x.tool_id === toolId);
    }

    function initializePlaybook() {
      const fab = document.getElementById("myPlaybookButton");
      const overlay = document.getElementById("playbookOverlay");
      const sidebar = document.getElementById("playbookSidebar");
      const closeBtn = document.getElementById("closePlaybook");
      const mobileTab = document.getElementById("mobileMyPlaybookTab");

      const open = () => {
        overlay?.classList.add("open");
        sidebar?.classList.add("open");
        renderSavedItems();
      };
      const close = () => {
        overlay?.classList.remove("open");
        sidebar?.classList.remove("open");
      };

      fab?.addEventListener("click", open);
      mobileTab?.addEventListener("click", (e) => { e.preventDefault(); open(); });
      closeBtn?.addEventListener("click", close);
      overlay?.addEventListener("click", (e) => { if (e.target === overlay) close(); });

      // Save item button
      document.getElementById("saveBtn")?.addEventListener("click", toggleSaveItem);

      // Initial state
      syncSaveItemButton();
      renderSavedItems();
    }

    function wireHeaderMyPlaybookHooks() {
      // nothing extra right now; FAB + mobile tab already wired
    }

    function wireFabKeyboard() {
      const fab = document.getElementById("myPlaybookButton");
      if (!fab) return;
      fab.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          fab.click();
        }
      });
    }

    function toggleSaveItem() {
      const title = "Micromanagement Framework";
      const href = window.location.pathname.split("/").pop() || "micromanagement-framework.html";
      const type = "Tool";

      const items = getSavedItems();
      const idx = items.findIndex(x => x && x.tool_id === TOOL_ID);

      if (idx >= 0) items.splice(idx, 1);
      else items.unshift({
        tool_id: TOOL_ID,
        title,
        type,
        href,
        saved_at: new Date().toISOString()
      });

      setSavedItems(items);
      syncSaveItemButton();
      renderSavedItems();
    }

    function syncSaveItemButton() {
      const btn = document.getElementById("saveBtn");
      if (!btn) return;
      const saved = isItemSaved(TOOL_ID);
      btn.classList.toggle("saved", saved);
      btn.querySelector("span").textContent = saved ? "Saved" : "Save item";
    }

    function renderSavedItems() {
      const list = document.getElementById("savedItemsList");
      const empty = document.getElementById("savedItemsEmpty");
      if (!list || !empty) return;

      const items = getSavedItems();
      if (!items.length) {
        empty.style.display = "block";
        list.innerHTML = "";
        return;
      }

      empty.style.display = "none";
      list.innerHTML = "";

      items.slice(0, 30).forEach(item => {
        const li = document.createElement("li");
        li.className = "saved-item";

        const dateTxt = item.saved_at ? fmtGB(item.saved_at) : "";
        li.innerHTML = `
          <div class="saved-item-title-row">
            <div class="saved-item-title">${escapeHtml(item.title || "Saved item")}</div>
            <div class="saved-item-type">${escapeHtml(item.type || "Tool")}</div>
          </div>
          <div class="saved-item-meta">${dateTxt ? `Saved • ${escapeHtml(dateTxt)}` : ""}</div>
          <div class="saved-item-actions">
            <a class="saved-item-link" href="${item.href || "#"}"><i class="fas fa-arrow-right"></i> Open</a>
            <button class="saved-item-remove" type="button">Remove</button>
          </div>
        `;

        li.querySelector(".saved-item-remove")?.addEventListener("click", () => {
          const all = getSavedItems().filter(x => x && x.tool_id !== item.tool_id);
          setSavedItems(all);
          syncSaveItemButton();
          renderSavedItems();
        });

        list.appendChild(li);
      });
    }

    /* =========================================================
       TELEMETRY (safe fail)
    ========================================================= */
    async function logTelemetry(eventName, meta = {}) {
      try {
        if (!window.__tep_supabase) return;
        // Optional table. Fail silently if missing.
        await window.__tep_supabase
          .from("activity_log")
          .insert([{ event_name: eventName, meta, tool_id: TOOL_ID }]);
      } catch (e) {}
    }

    /* =========================================================
       AUTH + HARD LOCK + CLOUD SAVE/RESTORE (tool_states)
    ========================================================= */
    function escapeHtml(str) {
      return String(str || "")
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }

    function applyLockState(isLocked) {
      const overlay = document.getElementById("authLockOverlay");
      const main = document.getElementById("toolMain");

      document.body.classList.toggle("auth-locked", !!isLocked);

      if (overlay) {
        overlay.classList.toggle("active", !!isLocked);
        overlay.setAttribute("aria-hidden", isLocked ? "false" : "true");
      }

      // True hard lock: inert on main
      if (main) {
        if (isLocked) main.setAttribute("inert", "");
        else main.removeAttribute("inert");
      }

      syncActionButtons(!!isLocked);
    }

    // Global capture block when locked (prevents clicks/keys reaching UI)
    function installGlobalLockCapture() {
      const block = (e) => {
        if (!document.body.classList.contains("auth-locked")) return;
        // allow interactions inside overlay only
        const overlay = document.getElementById("authLockOverlay");
        if (overlay && overlay.contains(e.target)) return;

        e.preventDefault();
        e.stopPropagation();
      };

      ["click","mousedown","mouseup","pointerdown","pointerup","touchstart","touchend","keydown","keyup","keypress","input","change","submit"].forEach(evt => {
        document.addEventListener(evt, block, true);
      });
    }

    async function initSupabaseAuthAndLock() {
      installGlobalLockCapture();

      // Create client (from your config file globals)
      try {
        const url = window.TEP_SUPABASE_URL;
        const key = window.TEP_SUPABASE_ANON_KEY;
        if (url && key && window.supabase) {
          window.__tep_supabase = window.supabase.createClient(url, key);
        }
      } catch (e) {}

      const sb = window.__tep_supabase;

      // Default: locked until proven signed in
      applyLockState(true);

      if (!sb) return;

      try {
        const { data } = await sb.auth.getSession();
        const session = data?.session || null;
        if (session?.user) {
          applyLockState(false);
          await hydrateHeaderIdentity(session.user);
          await restoreProgressFromCloudOrLocal();
          logTelemetry("tool_opened", { tool_id: TOOL_ID, tool_version: TOOL_VERSION });
        } else {
          applyLockState(true);
          await hydrateHeaderIdentity(null);
        }

        // Auth changes
        sb.auth.onAuthStateChange(async (_event, newSession) => {
          if (newSession?.user) {
            applyLockState(false);
            await hydrateHeaderIdentity(newSession.user);
            await restoreProgressFromCloudOrLocal();
            logTelemetry("tool_opened", { tool_id: TOOL_ID, tool_version: TOOL_VERSION });
          } else {
            applyLockState(true);
            await hydrateHeaderIdentity(null);
          }
        });

        // Logout button
        document.getElementById("logoutBtn")?.addEventListener("click", async (e) => {
          e.preventDefault();
          try { await sb.auth.signOut(); } catch (err) {}
        });

      } catch (e) {
        // If anything fails, stay locked
        applyLockState(true);
      }
    }

    async function hydrateHeaderIdentity(user) {
      const initialsBtn = document.getElementById("userInitialsBtn");
      const logoutBtn = document.getElementById("logoutBtn");
      const mobileProfileBtn = document.getElementById("mobileProfileBtn");

      if (!initialsBtn || !logoutBtn) return;

      if (!user) {
        initialsBtn.textContent = "…";
        initialsBtn.setAttribute("href", "sign-in.html");
        logoutBtn.style.display = "none";
        if (mobileProfileBtn) mobileProfileBtn.setAttribute("href", "sign-in.html");
        return;
      }

      initialsBtn.setAttribute("href", "profile.html");
      logoutBtn.style.display = "inline-flex";
      if (mobileProfileBtn) mobileProfileBtn.setAttribute("href", "profile.html");

      // Pull full_name from profiles if available
      let fullName = "";
      try {
        const sb = window.__tep_supabase;
        const { data } = await sb.from("profiles").select("full_name").eq("id", user.id).maybeSingle();
        fullName = data?.full_name || "";
      } catch (e) {}

      const email = user.email || "";
      const init = initialsFrom(fullName, email);
      initialsBtn.textContent = init;
    }

    function initialsFrom(fullName, email) {
      const name = (fullName || "").trim();
      if (name) {
        const parts = name.split(/\s+/).filter(Boolean);
        const a = parts[0]?.[0] || "";
        const b = parts.length > 1 ? (parts[parts.length - 1]?.[0] || "") : "";
        const init = (a + b).toUpperCase();
        return init || "ME";
      }
      const em = (email || "").trim();
      if (em) return em.slice(0, 2).toUpperCase();
      return "ME";
    }

    function collectToolState() {
      return {
        checkedItems: window.checkedItems || [],
        itemCategories: window.itemCategories || [],
        updated_at: new Date().toISOString()
      };
    }

    function applyToolState(state) {
      if (!state || !Array.isArray(state.checkedItems)) return;

      // Ensure checklist initialized
      const nodes = document.querySelectorAll(".checklist-item");
      if (!nodes.length) return;

      // Apply booleans
      window.checkedItems = state.checkedItems.slice(0, nodes.length);
      while (window.checkedItems.length < nodes.length) window.checkedItems.push(false);

      nodes.forEach((node, idx) => {
        const icon = node.querySelector("i");
        const checked = !!window.checkedItems[idx];
        if (!icon) return;

        icon.classList.remove("fa-square", "fa-check-square");
        icon.classList.add(checked ? "fa-check-square" : "fa-square");
        icon.style.color = checked ? "#5A4496" : "#7B5FC4";
        node.setAttribute("aria-pressed", checked ? "true" : "false");
      });

      updatePresenceScore();
    }

    async function restoreProgressFromCloudOrLocal() {
      // Cloud first
      const sb = window.__tep_supabase;
      if (sb) {
        try {
          const { data, error } = await sb
            .from("tool_states")
            .select("state, tool_version, updated_at")
            .eq("tool_id", TOOL_ID)
            .maybeSingle();

          if (!error && data?.state) {
            applyToolState(data.state);
            markLoaded();
            return;
          }
        } catch (e) {}
      }

      // Local fallback
      try {
        const raw = localStorage.getItem("tep_local_state_" + TOOL_ID);
        if (raw) {
          const parsed = JSON.parse(raw);
          applyToolState(parsed);
          markLoaded();
          return;
        }
      } catch (e) {}

      markNeutral();
    }

    async function saveProgressToCloud() {
      const sb = window.__tep_supabase;
      const locked = document.body.classList.contains("auth-locked");
      if (locked) return;

      const state = collectToolState();

      // Local fallback always
      try {
        localStorage.setItem("tep_local_state_" + TOOL_ID, JSON.stringify(state));
      } catch (e) {}

      if (!sb) {
        markSaved();
        logTelemetry("tool_saved", { tool_id: TOOL_ID, tool_version: TOOL_VERSION, mode: "local_only" });
        return;
      }

      try {
        const payload = { tool_id: TOOL_ID, state, tool_version: TOOL_VERSION };
        const { error } = await sb
          .from("tool_states")
          .upsert(payload, { onConflict: "user_id,tool_id" });

        if (error) throw error;

        markSaved();
        logTelemetry("tool_saved", { tool_id: TOOL_ID, tool_version: TOOL_VERSION, mode: "cloud" });
      } catch (e) {
        // still saved locally
        setSaveStatus("Saved locally • Cloud save failed", "err");
        logTelemetry("tool_saved", { tool_id: TOOL_ID, tool_version: TOOL_VERSION, mode: "local_fallback" });
      }
    }

  </script>
</body>
</html>
