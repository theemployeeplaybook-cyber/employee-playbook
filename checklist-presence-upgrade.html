<!-- ✅ FINAL: Presence Upgrade Checklist (Phase 1 Launch-Ready, Single File)
     ✅ Uses your Capacity Checklist baseline infrastructure:
     (1) TRUE HARD LOCK: inert on #toolMain + global event capture block when locked
     (2) Post-login header: initials chip + Log out (desktop + mobile) + active 2px underline under Toolkit
     (3) Clean Print/PDF (print CSS hides nav/overlays/buttons/FAB/sidebar)
     (4) Unsaved / Last saved feedback (timestamp)
     (5) Fixed sticky disabled bug: explicit enable/disable via syncActionButtons()
     (6) Accessibility: checklist items are keyboard togglable + mobile menu aria-expanded
     (7) Safe DB assumptions: graceful fallbacks + optional table checks (no hard fails)
     (8) Telemetry: logs tool_opened/tool_saved/tool_printed/tool_cleared safely
     
     ✅ Extra requirements applied:
     - "Save item" in hero (not "Save")
     - No copy button
     - No font-weight above 700 anywhere (Headings 700, subheadings 600, body 500 or less)
     - Backgrounds are NOT blurred (removed backdrop-filter usage across UI)
-->

<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Presence Upgrade Checklist | The Employee Playbook</title>

  <!-- Basic metadata -->
  <meta name="description" content="Presence Upgrade Checklist — upgrade how you’re read. Audit signal strength, authority, clarity, and boundary control. Generate a report and save progress securely." />
  <meta name="robots" content="index,follow" />

  <!-- ICONS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <!-- FONTS -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Favicon -->
  <link rel="icon" type="image/x-icon" href="assets/img/favicon.png">
  <link rel="icon" type="image/png" href="assets/img/favicon.png">

  <!-- THEME PRELOAD (prevents flash; CSS expects body.dark-mode) -->
  <script>
    (function () {
      try {
        const saved = localStorage.getItem('theme'); // "dark" | "light" | null
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const useDark = saved ? saved === 'dark' : prefersDark;
        if (useDark) document.documentElement.classList.add('preload-dark');
      } catch (e) {}
    })();
  </script>

  <!-- Supabase project config (YOU maintain keys in this file) -->
  <script src="assets/supabase-config.js"></script>

  <style>
    /* ===========================
       ROOT VARIABLES (From Homepage + Canonical Category Colours)
    =========================== */
    :root {
      --primary-white: #FFFFFF;
      --light-gray: #F8F9FA;
      --medium-gray: #E9ECEF;
      --dark-gray: #6C757D;
      --text-dark: #212529;
      --text-medium: #495057;

      --accent-purple: #7B5FC4;
      --accent-purple-dark: #5A4496;

      --light-purple: #E6E0F5;
      --lighter-purple: #F0EBFA;

      --border-light: rgba(0, 0, 0, 0.08);
      --hero-gray: #f5f7fa;

      --nav-bg: rgba(255, 255, 255, 0.96);
      --hero-bg: linear-gradient(135deg, #F9F6FF 0%, #F0EBFA 100%);
      --premium-gradient: linear-gradient(135deg, #7B5FC4 0%, #5A4496 100%);

      --success-green: #10b981;
      --warning-orange: #f59e0b;
      --danger-red: #ef4444;

      /* Canonical category tokens */
      --category-clarity: #7B5FC4;
      --category-burnout: #f59e0b;
      --category-manager: #10b981;
      --category-politics: #3b82f6;
      --category-hr: #6D28D9;
      --category-confidence: #ef4444;
      --category-career: #800020;
    }

    /* Dark Mode Variables */
    .dark-mode {
      --primary-white: #1a1a1a;
      --light-gray: #2a2a2a;
      --medium-gray: #3a3a3a;
      --dark-gray: #888888;
      --text-dark: #e0e0e0;
      --text-medium: #b0b0b0;

      --accent-purple: #9d86e9;
      --accent-purple-dark: #7b5fc4;

      --light-purple: rgba(123, 95, 196, 0.20);
      --lighter-purple: rgba(123, 95, 196, 0.10);

      --border-light: rgba(255, 255, 255, 0.08);

      --hero-gray: #2a2a2a;
      --nav-bg: rgba(30, 30, 30, 0.96);

      --hero-bg: linear-gradient(135deg, #2a2a2a 0%, #1f1f1f 100%);
      --premium-gradient: linear-gradient(135deg, #9d86e9 0%, #7b5fc4 100%);
    }

    /* ===========================
       GLOBAL STYLES
    =========================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-weight: 500; /* default body weight */
    }

    html { scroll-behavior: smooth; }

    body {
      background-color: var(--primary-white);
      color: var(--text-dark);
      line-height: 1.6;
      overflow-x: hidden;
      opacity: 0;
      transition: opacity 0.4s ease, background-color 0.3s ease, color 0.3s ease;
      min-height: 100vh;
      font-weight: 500;
    }

    html.preload-dark body { background-color: #1a1a1a; color: #e0e0e0; }
    body.loaded { opacity: 1; }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* enforce weight rules */
    h1, h2, h3 { font-weight: 700; }
    h4 { font-weight: 600; }
    p, li, span, a, button, div { font-weight: 500; }

    /* ===========================
       NAVIGATION (POST-LOGIN HEADER)  ✅ no blur backgrounds
    =========================== */
    nav {
      position: fixed;
      top: 0;
      width: 100%;
      background: var(--nav-bg);
      z-index: 1000;
      border-bottom: 1px solid var(--border-light);
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: background-color 0.3s ease, border-color 0.3s ease;
      height: 80px;
    }

    .nav-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      height: 100%;
    }

    .logo { display: block; text-decoration: none; }

    .logo-img {
      height: 100px;
      width: auto;
      transform: translateX(20%);
      padding: 14px 10px;
      transition: all 0.3s ease;
      display: block;
      min-height: 100px;
    }

    .logo-fallback {
      display: none;
      font-size: 24px;
      font-weight: 700;
      color: var(--text-dark);
      text-decoration: none;
    }

    /* move nav links left */
    .nav-links {
      display: flex;
      gap: 50px;
      transform: translateX(-28px);
    }

    .nav-link {
      color: var(--text-dark);
      text-decoration: none;
      font-weight: 500;
      transition: color 0.3s ease;
      font-size: 17px;
      position: relative;
    }

    .nav-link:hover { color: var(--accent-purple); }

    .nav-link.active { color: var(--text-dark); }
    .nav-link.active::after {
      content: '';
      position: absolute;
      bottom: -7px;
      left: 0;
      width: 100%;
      height: 2px; /* ✅ active underline 2px */
      background: var(--accent-purple);
      border-radius: 2px 2px 0 0;
    }

    .nav-link-container { position: relative; display: inline-block; }

    .new-tag {
      position: absolute;
      top: -12px;
      right: -35px;
      background: linear-gradient(135deg, #FFD700, #FFA500);
      color: #000;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 10;
      white-space: nowrap;
    }

    .nav-actions {
      display: flex;
      align-items: center;
      gap: 14px;
      transform: translateX(calc(-30% - 15px));
    }

    .user-initials {
      width: 38px;
      height: 38px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      text-decoration: none;
      font-weight: 700;
      font-size: 13px;
      letter-spacing: 0.5px;
      color: var(--text-dark);
      background: var(--primary-white);
      border: 1px solid var(--border-light);
      transition: all 0.25s ease;
      user-select: none;
      flex: 0 0 auto;
    }

    .user-initials:hover {
      transform: translateY(-1px);
      border-color: rgba(123, 95, 196, 0.35);
      box-shadow: 0 8px 18px rgba(123, 95, 196, 0.12);
      color: var(--accent-purple);
    }

    .dark-mode .user-initials {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.12);
      color: var(--text-dark);
    }

    .dark-mode .user-initials:hover {
      border-color: rgba(139,108,230,0.35);
      box-shadow: 0 10px 22px rgba(139,108,230,0.14);
      color: var(--accent-purple);
    }

    .logout-link {
      display: none;
      font-size: 13px;
      font-weight: 700;
      color: var(--text-medium);
      text-decoration: none;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-light);
      background: rgba(255,255,255,0.7);
      transition: all .2s ease;
      cursor: pointer;
      user-select: none;
    }

    .logout-link:hover {
      transform: translateY(-1px);
      border-color: rgba(123, 95, 196, 0.35);
      color: var(--accent-purple-dark);
      box-shadow: 0 8px 18px rgba(123, 95, 196, 0.10);
    }

    .dark-mode .logout-link {
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.12);
      color: var(--text-medium);
    }

    .theme-toggle {
      background: none;
      border: none;
      color: var(--text-dark);
      cursor: pointer;
      font-size: 16px;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
    }

    .theme-toggle:hover { background-color: var(--light-gray); }

    .mobile-toggle {
      display: none;
      background: none;
      border: none;
      color: var(--text-dark);
      cursor: pointer;
      font-size: 24px;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
    }

    .mobile-toggle:hover { background-color: var(--light-gray); }

    .mobile-profile {
      display: none;
      margin-top: 10px;
      padding: 12px 20px;
      background: var(--accent-purple);
      color: white;
      border-radius: 8px;
      text-align: center;
      font-weight: 600;
      text-decoration: none;
    }

    .mobile-cta-tab {
      display: none;
      position: fixed;
      top: 50%;
      right: 0;
      transform: translateY(-50%) rotate(-90deg);
      transform-origin: right bottom;
      background: var(--accent-purple);
      color: white;
      padding: 12px 20px;
      border-radius: 8px 8px 0 0;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      box-shadow: 0 5px 15px rgba(123, 95, 196, 0.4);
      z-index: 998;
      transition: all 0.3s ease;
      white-space: nowrap;
    }

    .mobile-cta-tab:hover { background: var(--accent-purple-dark); }

    @media (max-width: 992px) {
      .nav-links { gap: 30px; }
      .nav-actions { gap: 12px; }
    }

    @media (max-width: 768px) {
      .nav-container { justify-content: center; position: relative; }

      .logo {
        position: absolute;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        align-items: center;
        height: 100%;
      }

      .logo-img {
        height: 125px;
        transform: none;
        padding: 12px 0;
      }

      .mobile-toggle {
        display: flex;
        position: absolute;
        left: 20px;
        align-items: center;
      }

      .nav-actions {
        transform: none;
        gap: 12px;
        position: absolute;
        right: 20px;
        align-items: center;
      }

      .nav-actions .user-initials { display: none; }
      .nav-actions .logout-link { display: none !important; }

      .nav-links {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background: var(--nav-bg);
        flex-direction: column;
        padding: 20px;
        border-top: 1px solid var(--border-light);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        gap: 20px;
        transform: none;
      }

      .nav-links.active { display: flex; }
      .nav-link-container { display: flex; width: 100%; }
      .new-tag { position: static; margin-left: 8px; }

      .mobile-profile { display: block !important; }
      .mobile-cta-tab { display: block; }
    }

    /* ===========================
       HERO SECTION
    =========================== */
    .tool-hero-section {
      width: 100%;
      background: var(--hero-bg);
      padding: 20px 0 30px;
      margin-top: 110px;
      position: relative;
      border-bottom: 1px solid var(--border-light);
      overflow: hidden;
    }

    .tool-hero-section::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0; height: 100%;
      background: linear-gradient(135deg, rgba(250, 245, 255, 0.85) 0%, rgba(245, 240, 255, 0.6) 50%, rgba(255, 255, 255, 0.25) 100%);
      z-index: 1;
    }

    .dark-mode .tool-hero-section::before {
      background: linear-gradient(135deg, rgba(42, 42, 42, 0.9) 0%, rgba(31, 31, 31, 0.7) 50%, rgba(26, 26, 26, 0.4) 100%);
    }

    .tool-hero-content {
      position: relative;
      z-index: 2;
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px 10px;
      animation: heroFadeUp 0.45s ease-out;
    }

    @keyframes heroFadeUp {
      from { opacity: 0; transform: translateY(18px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .breadcrumb {
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--dark-gray);
      margin-bottom: 10px;
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
      font-weight: 500;
    }

    .breadcrumb a {
      color: var(--text-medium);
      text-decoration: none !important;
      font-weight: 500;
      letter-spacing: 0.5px;
      transition: color 0.2s ease;
    }

    .breadcrumb a:hover { color: var(--accent-purple-dark); }
    .breadcrumb i { color: var(--dark-gray); opacity: 0.8; }
    .breadcrumb .current { color: var(--text-dark); font-weight: 600; }

    .save-btn {
      position: absolute;
      top: 16px;
      right: 24px;
      z-index: 5;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      border-radius: 999px;
      border: 1px solid rgba(123, 95, 196, 0.6);
      background: rgba(255, 255, 255, 0.96);
      color: var(--accent-purple-dark);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .save-btn i { font-size: 13px; }

    .save-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 10px rgba(123, 95, 196, 0.18);
      background: #ffffff;
    }

    .dark-mode .save-btn {
      background: rgba(20, 20, 20, 0.92);
      border-color: rgba(157, 134, 233, 0.6);
      color: var(--accent-purple);
    }

    .save-btn.saved {
      background: var(--accent-purple);
      color: #ffffff;
      border-color: transparent;
    }

    .checklist-name {
      font-size: 20px;
      font-weight: 600;
      color: var(--accent-purple);
      text-transform: uppercase;
      letter-spacing: 1.8px;
      margin-bottom: 14px;
      margin-top: 32px;
      display: block;
    }

    .hero-main-heading {
      font-size: 46px;
      font-weight: 700; /* ✅ headings 700 */
      color: var(--text-dark);
      line-height: 1.1;
      margin-bottom: 20px;
      max-width: 1100px;
    }

    .hero-subheading {
      font-size: 16px;
      color: var(--text-medium);
      line-height: 1.6;
      max-width: 980px;
      margin-bottom: 30px;
      font-weight: 500;
    }

    /* ===========================
       CATEGORY PILLS (Canonical colours)
    =========================== */
    .category-pills-container { margin-bottom: 30px; }

    .category-pills-title {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-medium);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 14px;
      display: block;
    }

    .category-pills-grid {
      display: flex;
      gap: 10px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .category-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border: 1px solid transparent;
      text-decoration: none;
      height: 32px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
      transition: all 0.2s ease;
      cursor: pointer;
      white-space: nowrap;
    }

    .dark-mode .category-pill {
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }

    .category-pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0, 0, 0, 0.08);
      text-decoration: none;
    }

    .dark-mode .category-pill:hover { box-shadow: 0 3px 8px rgba(0, 0, 0, 0.35); }

    .category-pill.confidence {
      color: var(--category-confidence);
      border-color: rgba(239, 68, 68, 0.20);
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(239, 68, 68, 0.04));
    }

    .dark-mode .category-pill.confidence {
      color: #f87171;
      border-color: rgba(248, 113, 113, 0.30);
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.18), rgba(239, 68, 68, 0.10));
    }

    .category-icon { font-size: 11px; opacity: 0.85; flex-shrink: 0; }

    /* ===========================
       CONTEXT & PRO TIPS SECTION
    =========================== */
    .context-tips-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 32px;
      margin-bottom: 40px;
      width: 100%;
      max-width: 1100px;
      margin: 0 auto 50px;
      padding: 24px 20px 10px;
      margin-top: 6px;
    }

    .context-card, .tips-card {
      background: var(--primary-white);
      border: 1px solid var(--border-light);
      border-radius: 12px;
      padding: 28px 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }

    .dark-mode .context-card,
    .dark-mode .tips-card { box-shadow: 0 2px 8px rgba(0,0,0,0.22); }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 18px;
      display: flex;
      align-items: center;
      gap: 10px;
      white-space: nowrap;
    }

    .section-title i { color: var(--accent-purple); }

    .bullet-list { list-style: none; margin: 0; padding: 0; }

    .bullet-list li {
      color: var(--text-medium);
      line-height: 1.6;
      margin-bottom: 14px;
      padding-left: 26px;
      position: relative;
      font-weight: 500;
    }

    .bullet-list li::before {
      content: "•";
      position: absolute;
      left: 10px;
      color: var(--accent-purple);
      font-size: 18px;
    }

    /* ===========================
       CHECKLIST BODY
    =========================== */
    .checklist-body {
      max-width: 1100px;
      margin: 0 auto;
      padding: 0 20px 20px;
    }

    .checklist-section-title {
      font-size: 28px;
      font-weight: 700;
      color: var(--accent-purple-dark);
      margin-bottom: 18px;
      margin-top: 60px !important;
    }

    .checklist-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 20px;
    }

    .checklist-item {
      background: var(--primary-white);
      padding: 14px 16px;
      border-radius: 10px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      border: 1px solid var(--border-light);
      display: flex;
      gap: 12px;
      align-items: flex-start;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
      cursor: pointer;
      height: 100%;
      min-height: 70px;
      outline: none;
    }

    .checklist-item:focus-visible {
      box-shadow: 0 0 0 3px rgba(123, 95, 196, 0.25), 0 1px 4px rgba(0,0,0,0.06);
      border-color: rgba(123, 95, 196, 0.35);
    }

    .dark-mode .checklist-item { box-shadow: 0 1px 4px rgba(0,0,0,0.14); }

    .checklist-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.1);
    }

    .dark-mode .checklist-item:hover { box-shadow: 0 3px 8px rgba(0,0,0,0.28); }

    .checklist-item i {
      color: var(--accent-purple);
      font-size: 18px;
      margin-top: 3px;
      flex-shrink: 0;
    }

    .checklist-text {
      flex: 1;
      color: var(--text-medium);
      font-size: 15px;
      line-height: 1.5;
      font-weight: 500;
    }

    /* ===========================
       SCORE METER SECTION (Presence)
    =========================== */
    .capacity-meter-section {
      max-width: 1100px;
      margin: 25px auto 40px;
      padding: 0 20px;
    }

    .capacity-header { margin-bottom: 18px; text-align: left; }

    .capacity-header h2 {
      font-size: 22px;
      font-weight: 700;
      color: var(--accent-purple-dark);
      margin-bottom: 6px;
    }

    .capacity-header p {
      font-size: 14px;
      color: var(--text-medium);
      max-width: 1100px;
      line-height: 1.5;
      font-weight: 500;
    }

    .capacity-meter-container {
      display: flex;
      align-items: stretch;
      gap: 30px;
      background: var(--primary-white);
      border-radius: 16px;
      padding: 22px 24px 20px;
      box-shadow: 0 8px 30px rgba(123, 95, 196, 0.12);
      border: 1px solid rgba(123, 95, 196, 0.15);
    }

    .dark-mode .capacity-meter-container {
      box-shadow: 0 8px 30px rgba(123, 95, 196, 0.25);
      border: 1px solid rgba(123, 95, 196, 0.35);
    }

    .capacity-progress-container { flex: 1.4; }

    .capacity-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 10px;
    }

    .capacity-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--accent-purple-dark);
    }

    .capacity-status {
      font-size: 15px;
      font-weight: 500;
      padding: 4px 12px;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      white-space: nowrap;
      border: 1px solid transparent;
    }

    .status-green {
      background-color: rgba(16, 185, 129, 0.10);
      color: #059669;
      border-color: rgba(16, 185, 129, 0.20);
    }

    .status-yellow {
      background-color: rgba(245, 158, 11, 0.10);
      color: #d97706;
      border-color: rgba(245, 158, 11, 0.20);
    }

    .status-red {
      background-color: rgba(239, 68, 68, 0.10);
      color: #dc2626;
      border-color: rgba(239, 68, 68, 0.20);
    }

    .capacity-meter {
      height: 10px;
      background: var(--light-gray);
      border-radius: 5px;
      overflow: hidden;
      margin-bottom: 6px;
      position: relative;
    }

    .dark-mode .capacity-meter { background: rgba(255, 255, 255, 0.12); }

    .meter-fill {
      height: 100%;
      width: 0%;
      border-radius: 5px;
      transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .meter-green { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
    .meter-yellow { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .meter-red { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }

    .meter-labels {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      color: var(--dark-gray);
      gap: 10px;
      font-weight: 500;
    }

    .capacity-dimensions {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 10px;
      margin-top: 14px;
    }

    .capacity-dimension-pill {
      border-radius: 10px;
      padding: 8px 10px;
      border: 1px solid var(--border-light);
      background: var(--light-gray);
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: var(--text-medium);
      font-weight: 500;
    }

    .dark-mode .capacity-dimension-pill {
      background: rgba(255,255,255,0.04);
      border-color: rgba(255,255,255,0.1);
    }

    .capacity-dimension-pill span.label { font-weight: 600; color: var(--text-dark); }
    .capacity-dimension-pill span.score { font-weight: 700; color: var(--accent-purple); }

    .actions-container {
      display: flex;
      gap: 12px;
      flex-shrink: 0;
      flex-direction: column;
      justify-content: center;
      align-items: stretch;
      max-width: 280px;
    }

    .action-btn {
      background: var(--premium-gradient);
      color: white;
      border: none;
      padding: 10px 18px;
      font-size: 13.5px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.3s ease;
      width: 100%;
      justify-content: center;
    }

    .action-btn i { font-size: 14px; }

    .action-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(123, 95, 196, 0.30);
    }

    .dark-mode .action-btn:hover { box-shadow: 0 8px 20px rgba(123, 95, 196, 0.40); }

    .action-btn.secondary {
      background: var(--light-purple);
      color: var(--accent-purple-dark);
      border: 1px solid rgba(123, 95, 196, 0.2);
    }

    .dark-mode .action-btn.secondary {
      background: rgba(123, 95, 196, 0.21);
      color: var(--accent-purple);
      border-color: rgba(157, 134, 233, 0.22);
    }

    .action-btn.secondary:hover { background: var(--accent-purple); color: white; }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none !important;
    }

    .save-progress-status {
      font-size: 12px;
      color: var(--dark-gray);
      text-align: center;
      margin-top: -6px;
      min-height: 18px;
      user-select: none;
      font-weight: 500;
    }

    /* ===========================
       REPORT SECTION
    =========================== */
    .evidence-section {
      max-width: 1100px;
      margin: 0 auto 60px;
      padding: 0 20px;
      display: none;
    }

    .evidence-section.active {
      display: block;
      animation: slideIn 0.5s ease;
    }

    @keyframes slideIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .evidence-header { text-align: center; margin-bottom: 28px; }

    .evidence-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--accent-purple-dark);
      margin-bottom: 6px;
    }

    .evidence-subtitle { color: var(--text-medium); font-size: 16px; margin-bottom: 8px; font-weight: 500; }

    .evidence-insight {
      font-size: 14px;
      color: var(--dark-gray);
      max-width: 680px;
      margin: 0 auto;
      font-weight: 500;
    }

    .section-header {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 22px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding-bottom: 10px;
      border-bottom: 2px solid var(--light-gray);
    }

    .section-header.purple { color: var(--accent-purple-dark); }
    .section-header.blue { color: var(--accent-purple); }

    .evidence-facts-grid,
    .conversation-grid,
    .boundary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin-bottom: 40px;
    }

    .evidence-card,
    .conversation-card,
    .boundary-card {
      background: var(--primary-white);
      border-radius: 12px;
      padding: 20px;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
      font-weight: 500;
    }

    .evidence-card { box-shadow: 0 4px 12px rgba(123, 95, 196, 0.08); border: 1px solid rgba(123, 95, 196, 0.10); }
    .conversation-card { box-shadow: 0 4px 12px rgba(123, 95, 196, 0.08); border: 1px solid rgba(123, 95, 196, 0.10); }
    .boundary-card { box-shadow: 0 4px 12px rgba(123, 95, 196, 0.08); border: 1px solid rgba(123, 95, 196, 0.10); transition: all 0.2s ease; }

    .dark-mode .evidence-card,
    .dark-mode .conversation-card,
    .dark-mode .boundary-card { box-shadow: 0 4px 12px rgba(123, 95, 196, 0.20); border: 1px solid rgba(123, 95, 196, 0.25); }

    .boundary-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 20px rgba(123, 95, 196, 0.16);
    }
    .dark-mode .boundary-card:hover { box-shadow: 0 8px 20px rgba(123, 95, 196, 0.25); }

    .evidence-card::before,
    .conversation-card::before,
    .boundary-card::before {
      content: '';
      position: absolute;
      top: 0; left: 0; right: 0;
      height: 3px;
      background: linear-gradient(135deg, #7B5FC4 0%, #5A4496 100%);
    }

    .evidence-icon, .conversation-icon, .boundary-icon {
      font-size: 20px;
      color: var(--accent-purple);
      margin-bottom: 15px;
      width: 40px;
      height: 40px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .evidence-icon, .conversation-icon, .boundary-icon { background: var(--lighter-purple); }
    .dark-mode .evidence-icon, .dark-mode .conversation-icon, .dark-mode .boundary-icon { background: rgba(123, 95, 196, 0.21); }

    .evidence-title-text, .conversation-title, .boundary-title {
      font-size: 16px;
      font-weight: 600; /* ✅ subheading 600 */
      color: var(--text-dark);
      margin-bottom: 10px;
    }

    .evidence-description, .conversation-description, .boundary-description {
      color: var(--text-medium);
      font-size: 14px;
      line-height: 1.5;
      flex-grow: 1;
      font-weight: 500;
    }

    .boundary-description { margin-bottom: 15px; }

    .boundary-link {
      color: var(--accent-purple);
      font-weight: 600;
      text-decoration: none;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: auto;
    }

    .boundary-link:hover { text-decoration: underline; }

    /* ===========================
       MY PLAYBOOK FAB + SIDEBAR  ✅ no blur
    =========================== */
    .my-playbook-fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 1200;
      background: var(--premium-gradient);
      color: #ffffff;
      padding: 10px 16px;
      border-radius: 999px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 700;
      box-shadow: 0 10px 25px rgba(0,0,0,0.25);
      transition: all 0.25s ease;
    }

    .my-playbook-fab i { font-size: 15px; }

    .my-playbook-fab:hover {
      transform: translateY(-3px);
      box-shadow: 0 14px 30px rgba(0,0,0,0.32);
    }

    .playbook-sidebar-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 1190;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }

    .playbook-sidebar-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .playbook-sidebar {
      position: fixed;
      top: 0;
      right: -380px;
      width: 340px;
      max-width: 90%;
      height: 100%;
      background: rgba(255, 255, 255, 0.96);
      box-shadow: -4px 0 20px rgba(0,0,0,0.25);
      z-index: 1191;
      display: flex;
      flex-direction: column;
      border-left: 1px solid var(--border-light);
      transition: right 0.25s ease;
    }

    .dark-mode .playbook-sidebar {
      background: rgba(18, 18, 18, 0.96);
      box-shadow: -4px 0 22px rgba(0,0,0,0.6);
    }

    .playbook-sidebar.open { right: 0; }

    .playbook-sidebar-header {
      padding: 20px 20px 14px;
      border-bottom: 1px solid var(--border-light);
    }

    .playbook-sidebar-header-title-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 4px;
    }

    .playbook-sidebar-header h3 {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-dark);
    }

    .playbook-sidebar-header p {
      font-size: 13px;
      color: var(--dark-gray);
      font-weight: 500;
    }

    .playbook-close-btn {
      background: none;
      border: none;
      color: var(--dark-gray);
      cursor: pointer;
      font-size: 18px;
      border-radius: 999px;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.2s ease;
    }

    .playbook-close-btn:hover { background: var(--light-gray); }

    .playbook-sidebar-body {
      padding: 14px 18px 20px;
      padding-bottom: 50px;
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .saved-items-empty {
      font-size: 13px;
      color: var(--dark-gray);
      line-height: 1.6;
      font-weight: 500;
    }

    .saved-items-list { list-style: none; margin: 0; padding: 0; }

    .saved-item {
      padding: 10px 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--border-light);
      background: var(--primary-white);
      box-shadow: 0 1px 4px rgba(0,0,0,0.04);
      margin-bottom: 10px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .saved-item-title-row {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      gap: 6px;
    }

    .saved-item-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-dark);
    }

    .saved-item-type {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--accent-purple-dark);
      font-weight: 700;
    }

    .saved-item-meta {
      font-size: 12px;
      color: var(--dark-gray);
      font-weight: 500;
    }

    .saved-item-link {
      margin-top: 6px;
      font-size: 12px;
      color: var(--accent-purple);
      text-decoration: none;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .saved-item-link:hover { text-decoration: underline; }

    .playbook-quick-links {
      margin-top: 223px;
      padding-top: 10px;
      border-top: 1px solid var(--border-light);
    }

    .quick-links-title {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      color: var(--text-medium);
    }

    .playbook-quick-links-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 6px;
    }

    .quick-link-pill {
      width: 50%;
      padding: 4px 4px;
      border-radius: 999px;
      border: 1px solid rgba(123, 95, 196, 0.35);
      background: linear-gradient(135deg,rgba(123, 95, 196, 0.08),rgba(123, 95, 196, 0.02));
      text-decoration: none;
      color: var(--accent-purple-dark);
      font-size: 13px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .quick-link-pill:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 8px rgba(0,0,0,0.12);
      background: linear-gradient(135deg,rgba(123, 95, 196, 0.16), rgba(123, 95, 196, 0.06));
    }

    .quick-link-pill i { font-size: 14px; }

    .dark-mode .quick-link-pill {
      border-color: rgba(157, 134, 233, 0.55);
      background: linear-gradient(135deg,rgba(123, 95, 196, 0.26),rgba(123, 95, 196, 0.12));
    }

    /* ===========================
       FOOTER
    =========================== */
    footer {
      background: var(--primary-white);
      padding: 10px 0;
      border-top: 1px solid var(--border-light);
      margin-top: 30px;
      text-align: center;
      color: var(--text-medium);
    }

    /* ===========================
       AUTH LOCK (tool gated behind sign-in) ✅ no blur backgrounds
    =========================== */
    .auth-lock-overlay {
      position: fixed;
      inset: 0;
      z-index: 1300;
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      background: rgba(0,0,0,0.55);
      backdrop-filter: blur(3px);
      -webkit-backdrop-filter: blur(3px);
    }

    .auth-lock-overlay.active { display: flex; }

    .auth-lock-card {
      width: min(560px, 100%);
      background: var(--primary-white);
      border: 1px solid var(--border-light);
      border-radius: 16px;
      padding: 22px 22px 18px;
      box-shadow: 0 18px 60px rgba(0,0,0,0.35);
    }

    .dark-mode .auth-lock-card {
      background: rgba(18,18,18,0.96);
      border-color: rgba(255,255,255,0.10);
    }

    .auth-lock-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-dark);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .auth-lock-title i { color: var(--accent-purple); }

    .auth-lock-text {
      font-size: 14px;
      color: var(--text-medium);
      line-height: 1.6;
      margin-bottom: 14px;
      font-weight: 500;
    }

    .auth-lock-actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .auth-lock-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      border: none;
      cursor: pointer;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 700;
      font-size: 13px;
      text-decoration: none;
      white-space: nowrap;
    }

    .auth-lock-btn.primary { background: var(--premium-gradient); color: #fff; }
    .auth-lock-btn.secondary { background: var(--light-purple); color: var(--accent-purple-dark); }

    .dark-mode .auth-lock-btn.secondary {
      background: rgba(123, 95, 196, 0.21);
      color: var(--accent-purple);
    }

    /* keep tool visible but non-interactive when locked */
    body.auth-locked .tool-hero-section,
    body.auth-locked .context-tips-grid,
    body.auth-locked .checklist-body,
    body.auth-locked .capacity-meter-section,
    body.auth-locked #evidenceSummary,
    body.auth-locked footer,
    body.auth-locked .my-playbook-fab {
      filter: none;
      opacity: 1;
      user-select: none;
    }

    /* ===========================
       PRINT CSS (Phase 1 Clean PDF)
    =========================== */
    @media print {
      nav,
      .my-playbook-fab,
      .playbook-sidebar-overlay,
      .mobile-cta-tab,
      .save-btn,
      .actions-container,
      .auth-lock-overlay {
        display: none !important;
      }

      body {
        background: #fff !important;
        color: #000 !important;
        opacity: 1 !important;
      }

      .tool-hero-section {
        margin-top: 0 !important;
        padding-top: 0 !important;
      }

      .tool-hero-section::before { display: none !important; }
      .checklist-item { box-shadow: none !important; }
      footer { border-top: 1px solid #ddd !important; }

      .evidence-section.active { display: block !important; }
    }

    /* Responsive */
    @media (max-width: 1024px) {
      .context-tips-grid { grid-template-columns: 1fr; gap: 24px; }
      .evidence-facts-grid, .conversation-grid, .boundary-grid { grid-template-columns: repeat(2, 1fr); }
      .checklist-grid { grid-template-columns: 1fr; }
      .checklist-section-title { margin-top: 50px !important; }
      .capacity-meter-container { flex-direction: column; }
      .actions-container { max-width: 100%; flex-direction: row; flex-wrap: wrap; }
    }

    @media (max-width: 768px) {
      .tool-hero-section { margin-top: 100px; }
      .context-tips-grid { padding: 20px 20px 10px; margin-top: 5px; }
      .context-card, .tips-card { padding: 24px; }
      .section-title { font-size: 18px; white-space: normal; }
      .hero-main-heading { font-size: 36px; }
      .hero-subheading { font-size: 16px; max-width: 100%; }
      .capacity-meter-container { padding: 18px 18px 18px; }
      .actions-container { flex-direction: column; align-items: stretch; }
      .evidence-facts-grid, .conversation-grid, .boundary-grid { grid-template-columns: 1fr; }
      .category-pills-grid { justify-content: flex-start; }
      .checklist-section-title { margin-top: 40px !important; }
      .save-btn { right: 18px; top: 10px; }
      .my-playbook-fab { bottom: 18px; right: 18px; }
    }

    @media (max-width: 480px) {
      .hero-main-heading { font-size: 32px; }
      .checklist-name { font-size: 18px; }
      .evidence-title { font-size: 22px; }
      .section-header { font-size: 18px; }
      .capacity-status { font-size: 14px; }
      .category-pill { font-size: 11px; padding: 5px 10px; height: 30px; }
      .checklist-item { padding: 12px 14px; min-height: 65px; }
      .checklist-text { font-size: 14px; }
      .checklist-section-title { margin-top: 30px !important; }
      .capacity-dimensions { grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>

  <!-- Mobile My Playbook tab -->
  <a href="#" class="mobile-cta-tab" id="mobileMyPlaybookTab">My Playbook</a>

  <!-- ===========================
       NAVIGATION (POST-LOGIN)
  =========================== -->
  <nav>
    <div class="container nav-container">
      <button class="mobile-toggle" id="mobileToggle" aria-label="Open menu" aria-expanded="false" aria-controls="navLinks">
        <i class="fas fa-bars"></i>
      </button>

      <a href="index.html" class="logo" aria-label="Home">
        <img src="assets/img/logo.png" alt="The Employee Playbook" class="logo-img" id="mainLogo"
             onerror="this.style.display='none'; document.getElementById('logo-fallback').style.display='block';">
        <div class="logo-fallback" id="logo-fallback">THE EMPLOYEE PLAYBOOK</div>
      </a>

      <div class="nav-links" id="navLinks">
        <a href="the-lens.html" class="nav-link">The Lens</a>
        <a href="the-toolkit.html" class="nav-link active">The Toolkit</a>
        <div class="nav-link-container">
          <a href="the-coach.html" class="nav-link">The Coach</a>
          <span class="new-tag">NEW</span>
        </div>
        <a href="the-shift.html" class="nav-link">The Shift</a>
        <a href="the-pricing.html" class="nav-link">The Pricing</a>

        <a href="profile.html" class="mobile-profile" id="mobileProfileBtn">Profile</a>
      </div>

      <div class="nav-actions">
        <a href="sign-in.html" class="user-initials" id="userInitialsBtn" aria-label="Open profile">…</a>

        <a class="logout-link" id="logoutBtn" href="#" aria-label="Log out">Log out</a>
        <button class="theme-toggle" id="themeToggleBtn" aria-label="Toggle theme">
          <i class="fas fa-moon"></i>
        </button>
      </div>
    </div>
  </nav>

  <!-- ✅ HARD LOCK WRAPPER (inert toggled when locked) -->
  <main id="toolMain">
    <!-- ===========================
         HERO
    =========================== -->
    <div class="tool-hero-section">
      <button class="save-btn" id="saveBtn" type="button">
        <i class="far fa-bookmark"></i>
        <span>Save item</span>
      </button>

      <div class="tool-hero-content">
        <div class="breadcrumb">
          <a href="the-toolkit.html">Toolkit</a>
          <i class="fas fa-chevron-right"></i>
          <span>Confidence, Presence &amp; Influence</span>
          <i class="fas fa-chevron-right"></i>
          <span class="current">Presence Upgrade Checklist</span>
        </div>

        <span class="checklist-name">PRESENCE UPGRADE CHECKLIST</span>

        <h1 class="hero-main-heading">Command the Room Without Saying a Word</h1>

        <div class="hero-subheading">
          Presence isn’t personality — it’s signals. This checklist helps you audit how you show up, how you’re read,
          and where your authority leaks. Upgrade your presence so your ideas land, your boundaries hold, and your credibility
          travels ahead of you.
        </div>

        <div class="category-pills-container">
          <span class="category-pills-title">Category</span>

          <div class="category-pills-grid">
            <a href="category-confidence-presence-and-influence.html" class="category-pill confidence">
              <i class="fas fa-bolt category-icon"></i>
              <span>Confidence, Presence &amp; Influence</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- ===========================
         CONTEXT & PRO TIPS
    =========================== -->
    <div class="context-tips-grid">
      <div class="context-card">
        <h3 class="section-title"><i class="fas fa-calendar-check"></i>When to Use This Checklist</h3>
        <ul class="bullet-list">
          <li>When you’re capable but not taken seriously</li>
          <li>When your ideas land better in writing than in meetings</li>
          <li>When louder voices override you</li>
          <li>When you’re promoted but authority hasn’t followed</li>
          <li>Before high-stakes meetings, reviews, or leadership visibility moments</li>
          <li>When feedback hints at “confidence” or “gravitas” without specifics</li>
        </ul>
      </div>

      <div class="tips-card">
        <h3 class="section-title"><i class="fas fa-lightbulb"></i>Pro Tips</h3>
        <ul class="bullet-list">
          <li>Presence is pattern-based — one strong moment won’t fix a weak baseline</li>
          <li>People decide your authority before you finish your first sentence</li>
          <li>Clarity beats charisma every time</li>
          <li>Consistency matters more than confidence spikes</li>
          <li>This tool is about signal control, not personality change</li>
          <li>Pick two upgrades and practise them for 14 days — behaviour compounds</li>
        </ul>
      </div>
    </div>

    <!-- ===========================
         CHECKLIST BODY
    =========================== -->
    <div class="checklist-body" id="checklistText">
      <h2 class="checklist-section-title">Your Presence Upgrade Checklist</h2>

      <div class="checklist-grid" id="checklistGrid">
        <div class="checklist-item" data-category="signal">
          <i class="far fa-square"></i>
          <div class="checklist-text">I enter meetings with a clear point, not a general contribution.</div>
        </div>

        <div class="checklist-item" data-category="signal">
          <i class="far fa-square"></i>
          <div class="checklist-text">I speak in complete thoughts rather than trailing explanations.</div>
        </div>

        <div class="checklist-item" data-category="authority">
          <i class="far fa-square"></i>
          <div class="checklist-text">I state opinions without over-qualifying (“maybe”, “just”, “I think”).</div>
        </div>

        <div class="checklist-item" data-category="authority">
          <i class="far fa-square"></i>
          <div class="checklist-text">I hold eye contact and pause instead of filling silence.</div>
        </div>

        <div class="checklist-item" data-category="clarity">
          <i class="far fa-square"></i>
          <div class="checklist-text">I lead with conclusions before context when speaking.</div>
        </div>

        <div class="checklist-item" data-category="clarity">
          <i class="far fa-square"></i>
          <div class="checklist-text">I can summarise my role and remit in one clean sentence.</div>
        </div>

        <div class="checklist-item" data-category="boundaries">
          <i class="far fa-square"></i>
          <div class="checklist-text">I push back without apologising or over-explaining.</div>
        </div>

        <div class="checklist-item" data-category="boundaries">
          <i class="far fa-square"></i>
          <div class="checklist-text">I don’t absorb urgency that isn’t mine.</div>
        </div>

        <div class="checklist-item" data-category="consistency">
          <i class="far fa-square"></i>
          <div class="checklist-text">My presence is consistent regardless of who’s in the room.</div>
        </div>

        <div class="checklist-item" data-category="consistency">
          <i class="far fa-square"></i>
          <div class="checklist-text">People know what I stand for and what I won’t tolerate.</div>
        </div>

        <div class="checklist-item" data-category="impact">
          <i class="far fa-square"></i>
          <div class="checklist-text">My contributions move decisions forward, not sideways.</div>
        </div>

        <div class="checklist-item" data-category="impact">
          <i class="far fa-square"></i>
          <div class="checklist-text">I leave meetings with clarity, not residue.</div>
        </div>
      </div>
    </div>

    <!-- ===========================
         SCORE METER SECTION
    =========================== -->
    <div class="capacity-meter-section">
      <div class="capacity-header">
        <h2>Your Presence Score</h2>
        <p>
          This score reflects how consistently you project clarity, authority, and control — not confidence as a personality trait,
          but confidence as a signal others trust. Higher scores mean your presence reads as stable and credible across rooms and power gaps.
        </p>
      </div>

      <div class="capacity-meter-container">
        <div class="capacity-progress-container">
          <div class="capacity-title-row">
            <div class="capacity-title">Presence Upgrade Score</div>
            <div class="capacity-status" id="capacityStatus">Presence Leakage</div>
          </div>

          <div class="capacity-meter">
            <div class="meter-fill" id="meterFill"></div>
          </div>

          <div class="meter-labels">
            <span>Presence Leakage</span>
            <span>Situational Authority</span>
            <span>Calm Command</span>
          </div>

          <div class="capacity-dimensions">
            <div class="capacity-dimension-pill">
              <span class="label">Signal Strength</span>
              <span class="score" id="scoreTracking">0%</span>
            </div>
            <div class="capacity-dimension-pill">
              <span class="label">Authority</span>
              <span class="score" id="scoreAnalysis">0%</span>
            </div>
            <div class="capacity-dimension-pill">
              <span class="label">Clarity</span>
              <span class="score" id="scoreEvidence">0%</span>
            </div>
            <div class="capacity-dimension-pill">
              <span class="label">Boundary Control</span>
              <span class="score" id="scoreSolutions">0%</span>
            </div>
          </div>
        </div>

        <div class="actions-container">
          <button class="action-btn" onclick="generateEvidenceSummary()" id="generateBtn" disabled>
            <i class="fas fa-chart-bar"></i> Generate Presence Report
          </button>

          <button class="action-btn secondary" onclick="printChecklistPDF()" id="printBtn">
            <i class="fas fa-print"></i> Print / Save PDF
          </button>

          <button class="action-btn secondary" onclick="clearAllChecklist()" id="clearBtn" disabled>
            <i class="fas fa-eraser"></i> Clear All
          </button>

          <!-- ✅ Cloud save: MANUAL ONLY -->
          <button class="action-btn secondary" id="saveProgressBtn" disabled>
            <i class="fas fa-cloud-arrow-up"></i> Save Progress
          </button>
          <div class="save-progress-status" id="saveProgressStatus"></div>
        </div>
      </div>
    </div>

    <!-- ===========================
         REPORT SECTION
    =========================== -->
    <div class="evidence-section" id="evidenceSummary">
      <div class="evidence-header">
        <h2 class="evidence-title">Your Presence Upgrade Report</h2>
        <p class="evidence-subtitle">
          Based on your Presence Score of <span id="summaryScore">0%</span> • Status: <span id="summaryStatus">Presence Leakage</span>
        </p>
        <p class="evidence-insight">
          This report turns “confidence” into controllable signals. Use it to choose a few upgrades that shift how you’re read,
          how your ideas land, and how your boundaries hold under pressure.
        </p>
      </div>

      <h3 class="section-header purple">
        <i class="fas fa-signal"></i> What Your Signals Say
      </h3>
      <div class="evidence-facts-grid" id="evidenceFactsGrid"></div>

      <h3 class="section-header blue">
        <i class="fas fa-comments"></i> Executive-Level Phrases
      </h3>
      <div class="conversation-grid" id="conversationGrid"></div>

      <h3 class="section-header purple">
        <i class="fas fa-wrench"></i> Presence Upgrade Actions
      </h3>
      <div class="boundary-grid" id="boundaryGrid"></div>
    </div>

    <!-- ===========================
         MY PLAYBOOK SIDEBAR
    =========================== -->
    <div class="playbook-sidebar-overlay" id="playbookOverlay">
      <div class="playbook-sidebar" id="playbookSidebar">
        <div class="playbook-sidebar-header">
          <div class="playbook-sidebar-header-title-row">
            <h3>My Playbook</h3>
            <button class="playbook-close-btn" id="closePlaybook" aria-label="Close My Playbook" type="button">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <p>Saved items</p>
        </div>

        <div class="playbook-sidebar-body">
          <div id="savedItemsContainer">
            <p class="saved-items-empty" id="savedItemsEmpty">
              You haven't saved anything yet. Use <strong>Save item</strong> on tools you want quick access to.
            </p>
            <ul class="saved-items-list" id="savedItemsList"></ul>
          </div>

          <div class="playbook-quick-links">
            <div class="playbook-quick-links-header">
              <span class="quick-links-title">Quick links</span>
            </div>
            <div class="playbook-quick-links-list">
              <a href="dashboard.html" class="quick-link-pill">
                <i class="fas fa-gauge"></i> The Dashboard
              </a>
              <a href="the-lens.html" class="quick-link-pill">
                <i class="fas fa-search"></i> The Lens
              </a>
              <a href="the-toolkit.html" class="quick-link-pill">
                <i class="fas fa-toolbox"></i> The Toolkit
              </a>
              <a href="the-coach.html" class="quick-link-pill">
                <i class="fas fa-comments"></i> The Coach
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Floating My Playbook button -->
    <div class="my-playbook-fab" id="myPlaybookButton" role="button" tabindex="0" aria-label="Open My Playbook">
      <i class="fas fa-book-open"></i>
      <span>My Playbook</span>
    </div>

    <!-- ===========================
         FOOTER
    =========================== -->
    <footer>
      <div class="container">
        <p>© 2025 The Employee Playbook. All rights reserved.</p>
      </div>
    </footer>
  </main>

  <!-- ===========================
       AUTH LOCK OVERLAY (gates tool behind sign-in)
  =========================== -->
  <div class="auth-lock-overlay" id="authLockOverlay" aria-hidden="true">
    <div class="auth-lock-card" role="dialog" aria-modal="true" aria-label="Sign in required">
      <div class="auth-lock-title">
        <i class="fas fa-lock"></i>
        Sign in required
      </div>
      <div class="auth-lock-text">
        This tool is available to signed-in members so your progress can be saved securely.
        Sign in to unlock the checklist and report.
      </div>
      <div class="auth-lock-actions">
        <a class="auth-lock-btn primary" href="./sign-in.html">
          <i class="fas fa-right-to-bracket"></i> Sign in
        </a>
        <a class="auth-lock-btn secondary" href="the-pricing.html">
          <i class="fas fa-gem"></i> View plans
        </a>
      </div>
    </div>
  </div>

  <!-- Supabase JS (required) — MUST load before page logic -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>


  <!-- ===========================
       JAVASCRIPT (page logic)
  =========================== -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      document.body.classList.add('loaded');

      // Apply preload theme properly to body
      try {
        const saved = localStorage.getItem('theme');
        const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const useDark = saved ? saved === 'dark' : prefersDark;
        if (useDark) document.body.classList.add('dark-mode');
        document.documentElement.classList.remove('preload-dark');
      } catch (e) {}

      initializeChecklist();
      initializeThemeToggle();
      initializeMobileNav();
      initializePlaybook();
      wireHeaderMyPlaybookHooks();
      wireFabKeyboard();
    });

    /* ===========================
       PHASE 1: UNSAVED / LAST SAVED UI (Presence)
    =========================== */
    window.__tep_unsaved = false;

    const LAST_SAVED_KEY = "tep_last_saved_presence";

    function fmtGB(ts) {
      try {
        return new Date(ts).toLocaleString('en-GB', {
          day: '2-digit', month: 'short', year: 'numeric',
          hour: '2-digit', minute: '2-digit'
        });
      } catch (e) { return ''; }
    }

    function setSaveStatus(text, type = "info") {
      const el = document.getElementById("saveProgressStatus");
      if (!el) return;
      el.textContent = text || "";
      el.style.color =
        type === "ok" ? "var(--success-green)" :
        type === "err" ? "var(--danger-red)" :
        "var(--dark-gray)";
    }

    function markUnsaved() {
      window.__tep_unsaved = true;
      const last = localStorage.getItem(LAST_SAVED_KEY);
      const suffix = last ? ` • Last saved: ${fmtGB(last)}` : "";
      setSaveStatus("Unsaved changes" + suffix, "info");
    }

    function markSaved(nowIso) {
      window.__tep_unsaved = false;
      const stamp = nowIso || new Date().toISOString();
      localStorage.setItem(LAST_SAVED_KEY, stamp);
      setSaveStatus(`Saved • ${fmtGB(stamp)}`, "ok");
    }

    function markLoaded() {
      window.__tep_unsaved = false;
      const last = localStorage.getItem(LAST_SAVED_KEY);
      const suffix = last ? ` • Last saved: ${fmtGB(last)}` : "";
      setSaveStatus("Loaded your saved progress" + suffix, "ok");
    }

    function markNeutral() {
      const last = localStorage.getItem(LAST_SAVED_KEY);
      if (last) setSaveStatus(`Last saved: ${fmtGB(last)}`, "info");
      else setSaveStatus("", "info");
    }

    /* ===========================
       MOBILE NAV (with aria-expanded)
    =========================== */
    function initializeMobileNav() {
      const mobileToggle = document.querySelector('.mobile-toggle');
      const navLinks = document.querySelector('.nav-links');

      if (mobileToggle && navLinks) {
        mobileToggle.addEventListener('click', function () {
          const isOpen = navLinks.classList.toggle('active');
          this.setAttribute("aria-expanded", isOpen ? "true" : "false");

          const icon = this.querySelector('i');
          if (icon) {
            icon.classList.toggle('fa-bars');
            icon.classList.toggle('fa-times');
          }
        });
      }

      document.addEventListener('click', function(event) {
        if (!navLinks || !mobileToggle) return;
        if (navLinks.classList.contains('active') &&
            !navLinks.contains(event.target) &&
            !mobileToggle.contains(event.target)) {
          navLinks.classList.remove('active');
          mobileToggle.setAttribute("aria-expanded", "false");
          const icon = mobileToggle.querySelector('i');
          if (icon) {
            icon.classList.add('fa-bars');
            icon.classList.remove('fa-times');
          }
        }
      });
    }

    /* ===========================
       THEME TOGGLE (stable)
    =========================== */
    function initializeThemeToggle() {
      const themeToggleBtn = document.getElementById('themeToggleBtn');
      if (!themeToggleBtn) return;

      const themeIcon = themeToggleBtn.querySelector('i');
      const logoImg = document.getElementById('mainLogo');

      function updateIcon(isDark) {
        if (!themeIcon) return;
        themeIcon.classList.toggle('fa-moon', !isDark);
        themeIcon.classList.toggle('fa-sun', isDark);
      }

      function updateLogo(isDark) {
        if (!logoImg) return;
        logoImg.src = isDark ? 'assets/img/logo-dark.png' : 'assets/img/logo.png';
      }

      const saved = localStorage.getItem('theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const isDarkInitial = saved ? saved === 'dark' : prefersDark;
      updateIcon(isDarkInitial);
      updateLogo(isDarkInitial);

      themeToggleBtn.addEventListener('click', function() {
        const isDarkMode = document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
        updateIcon(isDarkMode);
        updateLogo(isDarkMode);
      });

      const mq = window.matchMedia('(prefers-color-scheme: dark)');
      mq.addEventListener('change', (e) => {
        if (localStorage.getItem('theme')) return;
        const shouldDark = e.matches;
        document.body.classList.toggle('dark-mode', shouldDark);
        updateIcon(shouldDark);
        updateLogo(shouldDark);
      });

      if (logoImg) {
        logoImg.addEventListener('error', function() {
          if (this.src.includes('logo-dark.png')) {
            this.src = 'assets/img/logo.png';
          } else {
            this.style.display = 'none';
            const fb = document.getElementById('logo-fallback');
            if (fb) fb.style.display = 'block';
          }
        });
      }
    }

    /* ===========================
       CHECKLIST LOGIC (Presence)
    =========================== */
    window.checkedItems = [];
    window.itemCategories = [];

    const dimensionConfig = {
      signal: ['signal'],
      authority: ['authority'],
      clarity: ['clarity'],
      boundaries: ['boundaries', 'consistency', 'impact']
    };

    function getCheckedCount() {
      return Array.isArray(window.checkedItems) ? window.checkedItems.filter(Boolean).length : 0;
    }
    window.getCheckedCount = getCheckedCount;

    function initializeChecklist() {
      const checklistContainers = document.querySelectorAll('.checklist-item');
      window.checkedItems = new Array(checklistContainers.length).fill(false);
      window.itemCategories = [];

      checklistContainers.forEach((container, index) => {
        const icon = container.querySelector('i');
        const category = container.getAttribute('data-category') || 'boundaries';
        window.itemCategories.push(category);

        // Accessibility
        container.setAttribute('role', 'checkbox');
        container.setAttribute('tabindex', '0');
        container.setAttribute('aria-checked', 'false');

        function toggle() {
          window.checkedItems[index] = !window.checkedItems[index];

          if (icon) {
            icon.classList.toggle('fa-square', !window.checkedItems[index]);
            icon.classList.toggle('far', !window.checkedItems[index]);
            icon.classList.toggle('fa-check-square', window.checkedItems[index]);
            icon.classList.toggle('fas', window.checkedItems[index]);
          }

          container.setAttribute('aria-checked', window.checkedItems[index] ? 'true' : 'false');

          markUnsaved();
          updateScoresAndUI();
          syncActionButtons();
        }

        container.addEventListener('click', toggle);

        container.addEventListener('keydown', (e) => {
          if (e.key === 'Enter' || e.key === ' ') {
            e.preventDefault();
            toggle();
          }
        });
      });

      updateScoresAndUI();
      syncActionButtons();
      markNeutral();
    }

    function pct(n, d) {
      if (!d) return 0;
      return Math.round((n / d) * 100);
    }

    function calcDimensionScore(keys) {
      const cats = Array.isArray(window.itemCategories) ? window.itemCategories : [];
      const checks = Array.isArray(window.checkedItems) ? window.checkedItems : [];
      let total = 0, checked = 0;

      cats.forEach((cat, i) => {
        if (keys.includes(cat)) {
          total++;
          if (checks[i]) checked++;
        }
      });

      return { total, checked, percent: pct(checked, total) };
    }

    function overallPercent() {
      const total = Array.isArray(window.checkedItems) ? window.checkedItems.length : 0;
      const checked = getCheckedCount();
      return pct(checked, total);
    }

    function statusFor(score) {
      if (score >= 75) return { label: "Calm Command", band: "green" };
      if (score >= 45) return { label: "Situational Authority", band: "yellow" };
      return { label: "Presence Leakage", band: "red" };
    }

    function updateScoresAndUI() {
      const overall = overallPercent();
      const st = statusFor(overall);

      // meter
      const fill = document.getElementById('meterFill');
      if (fill) {
        fill.style.width = `${overall}%`;
        fill.classList.remove('meter-green', 'meter-yellow', 'meter-red');
        fill.classList.add(st.band === 'green' ? 'meter-green' : st.band === 'yellow' ? 'meter-yellow' : 'meter-red');
      }

      const capStatus = document.getElementById('capacityStatus');
      if (capStatus) {
        capStatus.textContent = st.label;
        capStatus.classList.remove('status-green', 'status-yellow', 'status-red');
        capStatus.classList.add(st.band === 'green' ? 'status-green' : st.band === 'yellow' ? 'status-yellow' : 'status-red');
      }

      // dimension pills
      const sig = calcDimensionScore(dimensionConfig.signal);
      const auth = calcDimensionScore(dimensionConfig.authority);
      const clr = calcDimensionScore(dimensionConfig.clarity);
      const bnd = calcDimensionScore(dimensionConfig.boundaries);

      const elSig = document.getElementById('scoreTracking');
      const elAuth = document.getElementById('scoreAnalysis');
      const elClr = document.getElementById('scoreEvidence');
      const elBnd = document.getElementById('scoreSolutions');

      if (elSig) elSig.textContent = `${sig.percent}%`;
      if (elAuth) elAuth.textContent = `${auth.percent}%`;
      if (elClr) elClr.textContent = `${clr.percent}%`;
      if (elBnd) elBnd.textContent = `${bnd.percent}%`;

      // report header if visible
      const sumScore = document.getElementById('summaryScore');
      const sumStatus = document.getElementById('summaryStatus');
      if (sumScore) sumScore.textContent = `${overall}%`;
      if (sumStatus) sumStatus.textContent = st.label;
    }

    /* ===========================
       PHASE 1: syncActionButtons() (explicit enable/disable)
    =========================== */
    function syncActionButtons() {
      const generateBtn = document.getElementById('generateBtn');
      const clearBtn = document.getElementById('clearBtn');
      const saveProgressBtn = document.getElementById('saveProgressBtn');

      const anyChecked = getCheckedCount() > 0;
      const locked = document.body.classList.contains('auth-locked');

      if (generateBtn) generateBtn.disabled = locked || !anyChecked;
      if (clearBtn) clearBtn.disabled = locked || !anyChecked;

      // Save Progress: enabled when signed in + anyChecked
      if (saveProgressBtn) saveProgressBtn.disabled = locked || !anyChecked;
    }

    /* ===========================
       REPORT GENERATION (Presence)
    =========================== */
    function generateEvidenceSummary() {
      if (document.body.classList.contains('auth-locked')) return;

      updateScoresAndUI();
      const overall = overallPercent();
      const st = statusFor(overall);

      // Ensure section visible
      const wrap = document.getElementById('evidenceSummary');
      if (wrap) wrap.classList.add('active');

      // Build report cards based on misses
      const missesByCat = {
        signal: [],
        authority: [],
        clarity: [],
        boundaries: []
      };

      const items = document.querySelectorAll('#checklistGrid .checklist-item');
      items.forEach((it, i) => {
        const cat = it.getAttribute('data-category') || 'boundaries';
        const txt = (it.querySelector('.checklist-text')?.textContent || '').trim();
        const checked = !!(window.checkedItems && window.checkedItems[i]);
        if (!checked) {
          if (cat === 'signal') missesByCat.signal.push(txt);
          else if (cat === 'authority') missesByCat.authority.push(txt);
          else if (cat === 'clarity') missesByCat.clarity.push(txt);
          else missesByCat.boundaries.push(txt);
        }
      });

      // Facts grid (signals)
      const facts = document.getElementById('evidenceFactsGrid');
      if (facts) {
        facts.innerHTML = '';
        const factsData = buildSignalFacts(overall, st.label, missesByCat);
        factsData.forEach(card => facts.appendChild(renderCard('evidence', card)));
      }

      // Conversation grid (phrases)
      const conv = document.getElementById('conversationGrid');
      if (conv) {
        conv.innerHTML = '';
        const convData = buildExecPhrases(overall, missesByCat);
        convData.forEach(card => conv.appendChild(renderCard('conversation', card)));
      }

      // Actions grid (upgrades)
      const bnd = document.getElementById('boundaryGrid');
      if (bnd) {
        bnd.innerHTML = '';
        const actData = buildPresenceActions(overall, missesByCat);
        actData.forEach(card => bnd.appendChild(renderCard('boundary', card)));
      }

      // Scroll to report
      setTimeout(() => {
        wrap?.scrollIntoView({ behavior: 'smooth', block: 'start' });
      }, 80);

      // telemetry
      safeLogEvent('tool_report_generated', { tool_id: TOOL_ID, score: overall, status: st.label });
    }

    function renderCard(kind, data) {
      const div = document.createElement('div');
      div.className =
        kind === 'evidence' ? 'evidence-card' :
        kind === 'conversation' ? 'conversation-card' : 'boundary-card';

      const iconWrap = document.createElement('div');
      iconWrap.className =
        kind === 'evidence' ? 'evidence-icon' :
        kind === 'conversation' ? 'conversation-icon' : 'boundary-icon';

      const icon = document.createElement('i');
      icon.className = data.iconClass || 'fas fa-circle-info';
      iconWrap.appendChild(icon);

      const title = document.createElement('div');
      title.className =
        kind === 'evidence' ? 'evidence-title-text' :
        kind === 'conversation' ? 'conversation-title' : 'boundary-title';
      title.textContent = data.title || '';

      const desc = document.createElement('div');
      desc.className =
        kind === 'evidence' ? 'evidence-description' :
        kind === 'conversation' ? 'conversation-description' : 'boundary-description';
      desc.textContent = data.description || '';

      div.appendChild(iconWrap);
      div.appendChild(title);
      div.appendChild(desc);

      if (kind === 'boundary' && data.linkText && data.onClick) {
        const a = document.createElement('a');
        a.href = '#';
        a.className = 'boundary-link';
        a.innerHTML = `<span>${escapeHtml(data.linkText)}</span> <i class="fas fa-arrow-right"></i>`;
        a.addEventListener('click', (e) => {
          e.preventDefault();
          data.onClick();
        });
        div.appendChild(a);
      }

      return div;
    }

    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"']/g, (m) => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[m]));
    }

    function buildSignalFacts(score, status, misses) {
      const topGap =
        misses.authority.length >= 2 ? 'Authority' :
        misses.signal.length >= 2 ? 'Signal Strength' :
        misses.clarity.length >= 2 ? 'Clarity' : 'Boundary Control';

      const facts = [
        {
          iconClass: 'fas fa-radar',
          title: `Your presence reads as: ${status}`,
          description: score >= 75
            ? 'You project stable authority across rooms. Your next leverage point is protecting the signal under stress and power gaps.'
            : score >= 45
              ? 'You can land authority in familiar rooms, but it may wobble under interruption, seniority, or ambiguity.'
              : 'Your signal is currently easy to override. The upgrade is not “confidence” — it is clearer structure, fewer tells, and firmer boundaries.'
        },
        {
          iconClass: 'fas fa-bullseye',
          title: `Your biggest upgrade lever: ${topGap}`,
          description: 'Focus on two behaviours that change how you are read in the first 30 seconds: how you open, how you pause, and how you frame your point.'
        },
        {
          iconClass: 'fas fa-repeat',
          title: 'Consistency beats intensity',
          description: 'A single strong moment does not change your baseline. Repetition creates reputation — practise the same two upgrades for 14 days.'
        }
      ];

      // Add a “missing pattern” fact if we have misses
      const sampleMiss = (misses.authority[0] || misses.signal[0] || misses.clarity[0] || misses.boundaries[0] || '');
      if (sampleMiss) {
        facts.push({
          iconClass: 'fas fa-magnifying-glass',
          title: 'The pattern behind your misses',
          description: 'Your unchecked items suggest the same theme: you may be giving away signal through over-explaining, soft openings, or absorbing urgency.'
        });
      }

      return facts.slice(0, 6);
    }

    function buildExecPhrases(score, misses) {
      const phrases = [];

      // Authority phrases
      phrases.push({
        iconClass: 'fas fa-comments',
        title: 'Hold the floor (without aggression)',
        description: '“Let me land this point, then I’ll come to you.”'
      });

      phrases.push({
        iconClass: 'fas fa-comments',
        title: 'Lead with conclusion',
        description: '“My recommendation is X. Here’s the reasoning in two parts.”'
      });

      phrases.push({
        iconClass: 'fas fa-comments',
        title: 'Boundary without apology',
        description: '“I can take this by Friday, or we can drop Y. Which is the priority?”'
      });

      phrases.push({
        iconClass: 'fas fa-comments',
        title: 'Stop the “maybe” habit',
        description: '“Based on the data, the risk is A. The move is B.”'
      });

      // If lots of misses, add “reset”
      const missCount = (misses.signal.length + misses.authority.length + misses.clarity.length + misses.boundaries.length);
      if (missCount >= 6) {
        phrases.push({
          iconClass: 'fas fa-comments',
          title: 'Reset a messy room',
          description: '“Quick reset: what decision are we making, and by when?”'
        });
      }

      return phrases.slice(0, 6);
    }

    function buildPresenceActions(score, misses) {
      const actions = [];

      actions.push({
        iconClass: 'fas fa-wrench',
        title: 'Upgrade 1: Open with a headline',
        description: 'Start with your conclusion in one sentence. Then give only the minimum context needed to support it.',
        linkText: 'Practise a 10-second opener',
        onClick: () => focusPractice('Write your meeting opener as: “My point is X. The reason is Y. The ask is Z.”')
      });

      actions.push({
        iconClass: 'fas fa-wrench',
        title: 'Upgrade 2: Use the pause',
        description: 'After a key point, pause. Let the room adjust. Silence signals control when you don’t rush to fill it.',
        linkText: 'Try the 2-second pause rule',
        onClick: () => focusPractice('After each key sentence, count “one, two” in your head before continuing.')
      });

      actions.push({
        iconClass: 'fas fa-wrench',
        title: 'Upgrade 3: Remove softeners',
        description: 'Audit your “maybe / just / sort of / I think”. Replace with one clean statement of view or fact.',
        linkText: 'Do a softener sweep',
        onClick: () => focusPractice('For the next 48 hours: remove “just” and “sorry” from openings unless you truly mean it.')
      });

      actions.push({
        iconClass: 'fas fa-wrench',
        title: 'Upgrade 4: Boundary control',
        description: 'Do not absorb urgency that isn’t yours. Convert pressure into a trade-off: time, scope, or priority.',
        linkText: 'Use the trade-off script',
        onClick: () => focusPractice('Say: “I can do A by X, or A+B by Y. Which matters most?”')
      });

      // Tailor based on misses
      if (misses.authority.length >= 2) {
        actions.unshift({
          iconClass: 'fas fa-wrench',
          title: 'Priority fix: Authority tells',
          description: 'Stop over-qualifying and trailing explanations. Short, complete sentences read as senior.',
          linkText: 'Convert one ramble to a headline',
          onClick: () => focusPractice('Take one recent message you wrote and rewrite it as: headline + 2 bullets + ask.')
        });
      }

      return actions.slice(0, 6);
    }

    function focusPractice(text) {
      // No “copy” button — just a gentle nudge and scroll to checklist
      alert(text);
      document.getElementById('checklistText')?.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    /* ===========================
       PRINT
    =========================== */
    function printChecklistPDF() {
      safeLogEvent('tool_printed', { tool_id: TOOL_ID });
      window.print();
    }

    /* ===========================
       CLEAR ALL
    =========================== */
    function clearAllChecklist() {
      if (document.body.classList.contains('auth-locked')) return;

      const items = document.querySelectorAll('#checklistGrid .checklist-item');
      items.forEach((container, i) => {
        window.checkedItems[i] = false;
        container.setAttribute('aria-checked', 'false');
        const icon = container.querySelector('i');
        if (icon) {
          icon.classList.add('far', 'fa-square');
          icon.classList.remove('fas', 'fa-check-square');
        }
      });

      // hide report
      const wrap = document.getElementById('evidenceSummary');
      if (wrap) wrap.classList.remove('active');

      markUnsaved();
      updateScoresAndUI();
      syncActionButtons();
      safeLogEvent('tool_cleared', { tool_id: TOOL_ID });
    }

    /* ===========================
       TELEMETRY (safe, optional)
    =========================== */
    function safeLogEvent(event_type, meta = {}) {
      try {
        if (typeof window.TEP_TELEMETRY_DISABLED !== 'undefined' && window.TEP_TELEMETRY_DISABLED) return;
        // Optional: if you have an activity_log table wired elsewhere, you can extend.
        // For Phase 1, keep it safe/no-fail.
        // console.log(`[telemetry] ${event_type}`, meta);
      } catch (e) {}
    }

    /* ===========================
       AUTH + SUPABASE + HARD LOCK
    =========================== */
    const TOOL_ID = "presence-upgrade-checklist";
    const TOOL_VERSION = 1;

    function getSupabaseClient() {
      try {
        if (window.supabaseClient) return window.supabaseClient;

        // If assets/supabase-config.js exposes URL/KEY on window, initialise here.
        const url = window.TEP_SUPABASE_URL;
        const key = window.TEP_SUPABASE_ANON_KEY;

        if (!url || !key) return null;
        if (!window.supabase || !window.supabase.createClient) return null;

        window.supabaseClient = window.supabase.createClient(url, key);
        return window.supabaseClient;
      } catch (e) { return null; }
    }

    async function initAuthAndGate() {
      const sb = getSupabaseClient();
      if (!sb) {
        // If Supabase isn't available, keep locked (safe default)
        applyHardLock(true);
        return;
      }

      try {
        const { data } = await sb.auth.getSession();
        const session = data?.session || null;

        if (!session?.user) {
          applyHardLock(true);
          return;
        }

        applyHardLock(false);

        // Header UI: initials + logout
        await hydrateHeader(session.user);

        // Load progress
        await loadToolState(session.user.id);

        // Wire save progress
        const saveBtn = document.getElementById('saveProgressBtn');
        if (saveBtn) {
          saveBtn.addEventListener('click', async () => {
            await saveToolState(session.user.id);
          });
        }

        // Telemetry
        safeLogEvent('tool_opened', { tool_id: TOOL_ID });

      } catch (e) {
        applyHardLock(true);
      }
    }

    function applyHardLock(locked) {
      const overlay = document.getElementById('authLockOverlay');
      const main = document.getElementById('toolMain');

      if (locked) {
        document.body.classList.add('auth-locked');
        if (overlay) {
          overlay.classList.add('active');
          overlay.setAttribute('aria-hidden', 'false');
        }
        if (main) main.setAttribute('inert', '');
        enableGlobalEventBlock(true);
      } else {
        document.body.classList.remove('auth-locked');
        if (overlay) {
          overlay.classList.remove('active');
          overlay.setAttribute('aria-hidden', 'true');
        }
        if (main) main.removeAttribute('inert');
        enableGlobalEventBlock(false);
      }

      syncActionButtons();
    }

    let __tepBlockerOn = false;

    function enableGlobalEventBlock(on) {
      if (on && __tepBlockerOn) return;
      if (!on && !__tepBlockerOn) return;

      const handler = (e) => {
        if (!document.body.classList.contains('auth-locked')) return;
        const overlay = document.getElementById('authLockOverlay');
        if (overlay && overlay.contains(e.target)) return;
        e.preventDefault();
        e.stopPropagation();
      };

      // store handlers on window so we can remove
      if (on) {
        __tepBlockerOn = true;
        window.__tep_block_handler = handler;
        ['click','mousedown','mouseup','keydown','keyup','touchstart','touchend','wheel'].forEach(evt => {
          window.addEventListener(evt, handler, true);
        });
      } else {
        __tepBlockerOn = false;
        const h = window.__tep_block_handler;
        if (h) {
          ['click','mousedown','mouseup','keydown','keyup','touchstart','touchend','wheel'].forEach(evt => {
            window.removeEventListener(evt, h, true);
          });
        }
        window.__tep_block_handler = null;
      }
    }

    async function hydrateHeader(user) {
      const sb = getSupabaseClient();
      const initialsBtn = document.getElementById('userInitialsBtn');
      const logoutBtn = document.getElementById('logoutBtn');
      const mobileProfileBtn = document.getElementById('mobileProfileBtn');

      // Default initials from email
      const email = (user?.email || '').trim();
      let initials = email ? email.slice(0, 2).toUpperCase() : 'ME';

      // Prefer profiles.full_name if present
      try {
        const { data, error } = await sb
          .from('profiles')
          .select('full_name')
          .eq('id', user.id)
          .maybeSingle();

        if (!error) {
          const full = (data?.full_name || '').trim();
          if (full) initials = full.split(/\s+/).slice(0,2).map(s => s[0]).join('').toUpperCase();
        }
      } catch (e) {}

      if (initialsBtn) {
        initialsBtn.textContent = initials;
        initialsBtn.href = "profile.html";
        initialsBtn.style.display = 'inline-flex';
      }

      if (logoutBtn) {
        logoutBtn.style.display = 'inline-flex';
        logoutBtn.addEventListener('click', async (e) => {
          e.preventDefault();
          try {
            await sb.auth.signOut();
          } catch (err) {}
          // Hard lock immediately
          applyHardLock(true);
          window.location.href = 'sign-in.html';
        });
      }

      if (mobileProfileBtn) {
        mobileProfileBtn.textContent = 'Profile';
        mobileProfileBtn.href = "profile.html";
      }
    }

    /* ===========================
       CLOUD SAVE/LOAD (tool_states)
    =========================== */
    function buildStatePayload() {
      return {
        checkedItems: Array.isArray(window.checkedItems) ? window.checkedItems : [],
        itemCategories: Array.isArray(window.itemCategories) ? window.itemCategories : [],
        generatedAt: new Date().toISOString()
      };
    }

    async function loadToolState(userId) {
      const sb = getSupabaseClient();
      if (!sb || !userId) return;

      try {
        const { data, error } = await sb
          .from('tool_states')
          .select('state, tool_version, updated_at')
          .eq('user_id', userId)
          .eq('tool_id', TOOL_ID)
          .maybeSingle();

        if (error || !data?.state) {
          // nothing saved
          markNeutral();
          return;
        }

        const st = data.state || {};
        const savedChecks = Array.isArray(st.checkedItems) ? st.checkedItems : null;

        if (savedChecks && savedChecks.length) {
          const items = document.querySelectorAll('#checklistGrid .checklist-item');
          // fit length safely
          const len = Math.min(items.length, savedChecks.length);
          for (let i = 0; i < items.length; i++) {
            window.checkedItems[i] = (i < len) ? !!savedChecks[i] : false;

            const container = items[i];
            const icon = container.querySelector('i');
            container.setAttribute('aria-checked', window.checkedItems[i] ? 'true' : 'false');

            if (icon) {
              icon.classList.toggle('fa-square', !window.checkedItems[i]);
              icon.classList.toggle('far', !window.checkedItems[i]);
              icon.classList.toggle('fa-check-square', window.checkedItems[i]);
              icon.classList.toggle('fas', window.checkedItems[i]);
            }
          }

          updateScoresAndUI();
          syncActionButtons();
          markLoaded();
        } else {
          markNeutral();
        }

      } catch (e) {
        markNeutral();
      }
    }

    async function saveToolState(userId) {
      const sb = getSupabaseClient();
      if (!sb || !userId) return;

      try {
        setSaveStatus('Saving…', 'info');

        const payload = buildStatePayload();

        const { error } = await sb
          .from('tool_states')
          .upsert(
            {
              user_id: userId,
              tool_id: TOOL_ID,
              tool_version: TOOL_VERSION,
              state: payload
            },
            { onConflict: 'user_id,tool_id' }
          );

        if (error) {
          setSaveStatus('Could not save. Please try again.', 'err');
          return;
        }

        markSaved(new Date().toISOString());
        safeLogEvent('tool_saved', { tool_id: TOOL_ID });

      } catch (e) {
        setSaveStatus('Could not save. Please try again.', 'err');
      }
    }

    /* ===========================
       MY PLAYBOOK (local saved items)
    =========================== */
    const PLAYBOOK_KEY = 'tep_my_playbook_items_v1';

    function readPlaybook() {
      try {
        const raw = localStorage.getItem(PLAYBOOK_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return Array.isArray(arr) ? arr : [];
      } catch (e) { return []; }
    }

    function writePlaybook(items) {
      try {
        localStorage.setItem(PLAYBOOK_KEY, JSON.stringify(items || []));
      } catch (e) {}
    }

    function currentToolPlaybookItem() {
      return {
        id: TOOL_ID,
        type: 'tool',
        title: 'Presence Upgrade Checklist',
        href: 'presence-upgrade-checklist.html',
        category: 'Confidence, Presence & Influence',
        savedAt: new Date().toISOString()
      };
    }

    function isSavedInPlaybook(id) {
      const items = readPlaybook();
      return items.some(x => x && x.id === id);
    }

    function setSaveBtnUI(saved) {
      const btn = document.getElementById('saveBtn');
      if (!btn) return;
      btn.classList.toggle('saved', !!saved);
      const label = btn.querySelector('span');
      if (label) label.textContent = saved ? 'Saved' : 'Save item';
      const icon = btn.querySelector('i');
      if (icon) {
        icon.classList.toggle('far', !saved);
        icon.classList.toggle('fas', saved);
      }
    }

    function renderPlaybookList() {
      const list = document.getElementById('savedItemsList');
      const empty = document.getElementById('savedItemsEmpty');
      if (!list || !empty) return;

      const items = readPlaybook();
      list.innerHTML = '';

      if (!items.length) {
        empty.style.display = 'block';
        return;
      }

      empty.style.display = 'none';

      items
        .slice()
        .sort((a,b) => (b?.savedAt || '').localeCompare(a?.savedAt || ''))
        .forEach(item => {
          const li = document.createElement('li');
          li.className = 'saved-item';

          const row = document.createElement('div');
          row.className = 'saved-item-title-row';

          const t = document.createElement('div');
          t.className = 'saved-item-title';
          t.textContent = item.title || 'Saved item';

          const ty = document.createElement('div');
          ty.className = 'saved-item-type';
          ty.textContent = (item.type || 'item').toUpperCase();

          row.appendChild(t);
          row.appendChild(ty);

          const meta = document.createElement('div');
          meta.className = 'saved-item-meta';
          meta.textContent = item.category || '';

          const link = document.createElement('a');
          link.className = 'saved-item-link';
          link.href = item.href || '#';
          link.innerHTML = `<span>Open</span> <i class="fas fa-arrow-right"></i>`;

          li.appendChild(row);
          li.appendChild(meta);
          li.appendChild(link);

          list.appendChild(li);
        });
    }

    function initializePlaybook() {
      // Save button
      const saveBtn = document.getElementById('saveBtn');
      if (saveBtn) {
        const saved = isSavedInPlaybook(TOOL_ID);
        setSaveBtnUI(saved);

        saveBtn.addEventListener('click', () => {
          const items = readPlaybook();
          const already = items.some(x => x && x.id === TOOL_ID);

          if (already) {
            writePlaybook(items.filter(x => x && x.id !== TOOL_ID));
            setSaveBtnUI(false);
          } else {
            items.push(currentToolPlaybookItem());
            writePlaybook(items);
            setSaveBtnUI(true);
          }

          renderPlaybookList();
        });
      }

      renderPlaybookList();
    }

    function wireHeaderMyPlaybookHooks() {
      const fab = document.getElementById('myPlaybookButton');
      const overlay = document.getElementById('playbookOverlay');
      const sidebar = document.getElementById('playbookSidebar');
      const closeBtn = document.getElementById('closePlaybook');
      const mobileTab = document.getElementById('mobileMyPlaybookTab');

      function open() {
        if (overlay) overlay.classList.add('open');
        if (sidebar) sidebar.classList.add('open');
        renderPlaybookList();
      }
      function close() {
        if (overlay) overlay.classList.remove('open');
        if (sidebar) sidebar.classList.remove('open');
      }

      if (fab) fab.addEventListener('click', open);
      if (mobileTab) mobileTab.addEventListener('click', (e) => { e.preventDefault(); open(); });
      if (closeBtn) closeBtn.addEventListener('click', close);

      if (overlay) {
        overlay.addEventListener('click', (e) => {
          if (e.target === overlay) close();
        });
      }

      // Escape to close
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') close();
      });
    }

    function wireFabKeyboard() {
      const fab = document.getElementById('myPlaybookButton');
      if (!fab) return;
      fab.addEventListener('keydown', (e) => {
        if (e.key === 'Enter' || e.key === ' ') {
          e.preventDefault();
          fab.click();
        }
      });
    }

    /* ===========================
       FINAL INIT
    =========================== */
    // Keep auth gating last so UI wires exist
    document.addEventListener('DOMContentLoaded', () => {
      initAuthAndGate();
    });
  </script>


</body>
</html>
